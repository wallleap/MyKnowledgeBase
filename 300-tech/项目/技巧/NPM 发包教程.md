---
title: NPM å‘åŒ…æ•™ç¨‹
date: 2024-11-14T13:38:09+08:00
updated: 2024-11-14T13:38:38+08:00
dg-publish: false
---

ä»Šå¤©æˆ‘ä»¬å°†ä»ä¸€ä¸ªç©ºç›®å½•å¼€å§‹ï¼Œä¸€æ­¥æ­¥åœ°ä»‹ç»å¦‚ä½•å°†ä¸€ä¸ªåŒ…å‘å¸ƒåˆ° npmï¼Œå‘å¸ƒä¸€ä¸ªå®Œå…¨ç”Ÿäº§å¯ç”¨çš„åŒ…ã€‚è¿™å°†åŒ…æ‹¬ï¼š

- ä½¿ç”¨ Git è¿›è¡Œç‰ˆæœ¬æ§åˆ¶
- ä½¿ç”¨ TypeScript ç¼–å†™ä»£ç å¹¶ä¿æŒç±»å‹å®‰å…¨
- ä½¿ç”¨ Prettier æ ¼å¼åŒ–ä»£ç 
- ä½¿ç”¨ `@arethetypeswrong/cli` æ£€æŸ¥æˆ‘ä»¬çš„å¯¼å‡º
- ä½¿ç”¨ tsup å°† TypeScript ä»£ç ç¼–è¯‘ä¸º CJS å’Œ ESM
- ä½¿ç”¨ Vitest è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•
- ä½¿ç”¨ GitHub Actions è¿è¡Œæˆ‘ä»¬çš„ CI æµç¨‹
- ä½¿ç”¨ Changesets è¿›è¡Œç‰ˆæœ¬æ§åˆ¶å’Œå‘å¸ƒæˆ‘ä»¬çš„åŒ…

## **.1ï¼šåˆå§‹åŒ–ä»“åº“**

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ git ä»“åº“ï¼š

```
git init
```

## **1.2ï¼šè®¾ç½® `.gitignore`**

åœ¨é¡¹ç›®çš„æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `.gitignore` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```
node_modules
```

## **1.3ï¼šåˆ›å»ºåˆå§‹æäº¤**

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åˆ›å»ºåˆå§‹æäº¤ï¼š

```
git add .
git commit -m "Initial commit"
```

## **1.4ï¼šåœ¨ GitHub ä¸Šåˆ›å»ºæ–°ä»“åº“**

ä½¿ç”¨ GitHub CLIï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°ä»“åº“ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘é€‰æ‹©äº† `tt-package-demo` è¿™ä¸ªåå­—ï¼š

```
gh repo create tt-package-demo --source=. --public
```

## **1.5ï¼šæ¨é€åˆ° GitHub**

è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†ä½ çš„ä»£ç æ¨é€åˆ° GitHubï¼š

```
git push --set-upstream origin main
```

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª `package.json` æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ª `license` å­—æ®µï¼Œåˆ›å»ºä¸€ä¸ª `LICENSE` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª `README.md` æ–‡ä»¶ã€‚

## **2.1ï¼šåˆ›å»º `package.json` æ–‡ä»¶**

åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å€¼çš„ `package.json` æ–‡ä»¶ï¼š

```
{
  "name": "tt-package-demo",
  "version": "1.0.0",
  "description": "A demo package for Total TypeScript",
  "keywords": ["demo", "typescript"],
  "homepage": "https://github.com/yourgithub/tt-package-demo",
  "bugs": {
    "url": "https://github.com/yourgithub/tt-package-demo/issues"
  },
  "author": "Matt Pocock <team@totaltypescript.com> (https://totaltypescript.com)",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/yourgithub/tt-package-demo.git"
  },
  "files": ["dist"],
  "type": "module"
}
```

- `name` æ˜¯äººä»¬å°†ç”¨æ¥å®‰è£…ä½ çš„åŒ…çš„åç§°ã€‚å®ƒåœ¨ npm ä¸Šå¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚ä½ å¯ä»¥å…è´¹åˆ›å»ºç»„ç»‡ä½œç”¨åŸŸï¼ˆä¾‹å¦‚ `@total-typescript/demo`ï¼‰ï¼Œè¿™å¯ä»¥å¸®åŠ©å®ƒå˜å¾—å”¯ä¸€ã€‚
- `version` æ˜¯ä½ çš„åŒ…çš„ç‰ˆæœ¬ã€‚å®ƒåº”è¯¥éµå¾ªè¯­ä¹‰ç‰ˆæœ¬æ§åˆ¶ï¼š`0.0.1` æ ¼å¼ã€‚æ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ï¼Œä½ éƒ½åº”è¯¥å¢åŠ è¿™ä¸ªæ•°å­—ã€‚
- `description` å’Œ `keywords` æ˜¯ä½ çš„åŒ…çš„ç®€çŸ­æè¿°ã€‚å®ƒä»¬åœ¨ npm æ³¨å†Œè¡¨çš„æœç´¢ä¸­åˆ—å‡ºã€‚
- `homepage` æ˜¯ä½ çš„åŒ…ä¸»é¡µçš„ URLã€‚GitHub ä»“åº“æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é»˜è®¤é€‰æ‹©ï¼Œæˆ–è€…å¦‚æœä½ æœ‰ä¸€ä¸ªæ–‡æ¡£ç½‘ç«™çš„è¯ã€‚
- `bugs` æ˜¯äººä»¬å¯ä»¥æŠ¥å‘Šä½ çš„åŒ…é—®é¢˜çš„åœ°æ–¹çš„ URLã€‚
- `author` æ˜¯ä½ ï¼ä½ å¯ä»¥é€‰æ‹©æ·»åŠ ä½ çš„ç”µå­é‚®ä»¶å’Œç½‘ç«™ã€‚å¦‚æœä½ æœ‰å¤šä¸ªè´¡çŒ®è€…ï¼Œä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ ¼å¼å°†å®ƒä»¬æŒ‡å®šä¸º `contributors` æ•°ç»„ã€‚
- `repository` æ˜¯ä½ çš„åŒ…çš„ä»“åº“ URLã€‚è¿™åœ¨ npm æ³¨å†Œè¡¨ä¸Šåˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘ä½ çš„ GitHub ä»“åº“çš„é“¾æ¥ã€‚
- `files` æ˜¯å½“äººä»¬å®‰è£…ä½ çš„åŒ…æ—¶åº”åŒ…æ‹¬çš„æ–‡ä»¶æ•°ç»„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åŒ…æ‹¬äº† `dist` æ–‡ä»¶å¤¹ã€‚`README.md`ï¼Œ`package.json` å’Œ `LICENSE` é»˜è®¤è¢«åŒ…æ‹¬åœ¨å†…ã€‚
- `type` è®¾ç½®ä¸º `module` è¡¨ç¤ºä½ çš„åŒ…ä½¿ç”¨ ECMAScript æ¨¡å—ï¼Œè€Œä¸æ˜¯ CommonJS æ¨¡å—ã€‚

## **2.2ï¼šæ·»åŠ  `license` å­—æ®µ**

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `license` å­—æ®µã€‚åœ¨è¿™é‡Œé€‰æ‹©ä¸€ä¸ªè®¸å¯è¯ã€‚æˆ‘é€‰æ‹©äº† MITã€‚

```
{
  "license": "MIT"
}
```

## **2.3ï¼šæ·»åŠ  `LICENSE` æ–‡ä»¶**

åˆ›å»ºä¸€ä¸ªåä¸º `LICENSE`ï¼ˆæ— æ‰©å±•åï¼‰çš„æ–‡ä»¶ï¼ŒåŒ…å«ä½ çš„è®¸å¯è¯æ–‡æœ¬ã€‚å¯¹äº MITï¼Œè¿™æ˜¯ï¼š

```
MIT License

Copyright (c) [year] [fullname]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

å°† `[year]` å’Œ `[fullname]` å ä½ç¬¦æ›´æ”¹ä¸ºå½“å‰å¹´ä»½å’Œä½ çš„å§“åã€‚

## **2.4ï¼šæ·»åŠ  `README.md` æ–‡ä»¶**

åˆ›å»ºä¸€ä¸ª `README.md` æ–‡ä»¶ï¼Œæè¿°ä½ çš„åŒ…ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªä¾‹å­ï¼š

```
**tt-package-demo**

Total TypeScriptçš„ä¸€ä¸ªæ¼”ç¤ºåŒ…ã€‚
```

è¿™å°†åœ¨äººä»¬åœ¨ npm æ³¨å†Œè¡¨æŸ¥çœ‹ä½ çš„åŒ…æ—¶æ˜¾ç¤ºã€‚

## **3.1ï¼šå®‰è£… TypeScript**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… TypeScriptï¼š

```
npm install --save-dev typescript
```

æˆ‘ä»¬æ·»åŠ  `--save-dev` æ¥å°† TypeScript ä½œä¸ºå¼€å‘ä¾èµ–å®‰è£…ã€‚è¿™æ„å‘³ç€å½“äººä»¬å®‰è£…ä½ çš„åŒ…æ—¶ï¼Œå®ƒä¸ä¼šè¢«åŒ…å«åœ¨å†…ã€‚

## **3.2ï¼šè®¾ç½® `tsconfig.json`**

åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å€¼çš„ `tsconfig.json`ï¼š

```
{
  "compilerOptions": {
    /* åŸºç¡€é€‰é¡¹ï¼š*/
    "esModuleInterop": true,
    "skipLibCheck": true,
    "target": "es2022",
    "allowJs": true,
    "resolveJsonModule": true,
    "moduleDetection": "force",
    "isolatedModules": true,
    "verbatimModuleSyntax": true,

    /* ä¸¥æ ¼æ€§ */
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "noImplicitOverride": true,

    /* å¦‚æœä½¿ç”¨TypeScriptè½¬è¯‘ï¼š*/
    "module": "NodeNext",
    "outDir": "dist",
    "rootDir": "src",
    "sourceMap": true,

    /* å¦‚æœä½ æ­£åœ¨ä¸ºåº“æ„å»ºï¼š*/
    "declaration": true,

    /* å¦‚æœä½ æ­£åœ¨ä¸ºmonorepoä¸­çš„åº“æ„å»ºï¼š*/
    "declarationMap": true
  }
}
```

è¿™äº›é€‰é¡¹åœ¨æˆ‘çš„ TSConfig å¤‡å¿˜å•ä¸­æœ‰è¯¦ç»†è§£é‡Šã€‚

## **3.3ï¼šä¸º DOM é…ç½®ä½ çš„ `tsconfig.json`**

å¦‚æœä½ çš„ä»£ç åœ¨ DOM ä¸­è¿è¡Œï¼ˆå³éœ€è¦è®¿é—® `document`ã€`window` æˆ– `localStorage` ç­‰ï¼‰ï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ã€‚

å¦‚æœä½ çš„ä»£ç ä¸éœ€è¦è®¿é—® DOM APIï¼Œå°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ä½ çš„ `tsconfig.json`ï¼š

```
{
  "compilerOptions": {
    // ...å…¶ä»–é€‰é¡¹
    "lib": ["es2022"]
  }
}
```

è¿™å¯ä»¥é˜²æ­¢ DOM ç±»å‹å£°æ˜åœ¨ä½ çš„ä»£ç ä¸­å¯ç”¨ã€‚

å¦‚æœä½ ä¸ç¡®å®šï¼Œè·³è¿‡æ­¤æ­¥éª¤ã€‚

## **3.4ï¼šåˆ›å»ºä¸€ä¸ªæºæ–‡ä»¶**

åˆ›å»ºä¸€ä¸ªåä¸º `src/utils.ts` çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
export const add = (a: number, b: number) => a + b;
```

## **3.5ï¼šåˆ›å»ºä¸€ä¸ªç´¢å¼•æ–‡ä»¶**

åˆ›å»ºä¸€ä¸ªåä¸º `src/index.ts` çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
export { add } from "./utils.js";
```

`.js` æ‰©å±•åçœ‹èµ·æ¥å¯èƒ½æœ‰äº›å¥‡æ€ªã€‚æœ¬æ–‡æœ‰æ›´å¤šè§£é‡Šã€‚

## **3.6ï¼šè®¾ç½® `build` è„šæœ¬**

å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ä½ çš„ `package.json` çš„ `scripts` å¯¹è±¡ä¸­ï¼š

```
{
  "scripts": {
    "build": "tsc"
  }
}
```

è¿™å°†ç¼–è¯‘ä½ çš„ TypeScript ä»£ç ä¸º JavaScriptã€‚

## **3.7ï¼šè¿è¡Œæ„å»º**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç¼–è¯‘ä½ çš„ TypeScript ä»£ç ï¼š

```
npm run build
```

è¿™å°†åœ¨ `dist` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºç¼–è¯‘åçš„ JavaScript ä»£ç ã€‚

## **3.8ï¼šå°† `dist` æ·»åŠ åˆ° `.gitignore`**

å°† `dist` æ–‡ä»¶å¤¹æ·»åŠ åˆ°ä½ çš„ `.gitignore` æ–‡ä»¶ä¸­ï¼š

```
dist
```

è¿™å°†é˜²æ­¢ç¼–è¯‘åçš„ä»£ç è¢«åŒ…å«åœ¨ä½ çš„ git ä»“åº“ä¸­ã€‚

## **3.9ï¼šè®¾ç½® `ci` è„šæœ¬**

å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ä½ çš„ `package.json` çš„ `scripts` å¯¹è±¡ä¸­ï¼Œè®¾ç½® `ci` è„šæœ¬ï¼š

```
{
  "scripts": {
    "ci": "npm run build"
  }
}
```

è¿™ä¸ºæˆ‘ä»¬åœ¨ CI ä¸Šè¿è¡Œæ‰€æœ‰å¿…éœ€çš„æ“ä½œæä¾›äº†ä¸€ä¸ªå¿«æ·æ–¹å¼ã€‚

## **4.1: å®‰è£… Prettier**

è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… Prettierï¼š

```
npm install --save-dev prettier
```

## **4.2: è®¾ç½® `.prettierrc`**

åˆ›å»ºä¸€ä¸ª `.prettierrc` æ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
{
  "semi": true,
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 80,
  "tabWidth": 2
}
```

ä½ å¯ä»¥å‘æ­¤æ–‡ä»¶æ·»åŠ æ›´å¤šé€‰é¡¹ä»¥è‡ªå®šä¹‰ Prettier çš„è¡Œä¸ºã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å®Œæ•´çš„é€‰é¡¹åˆ—è¡¨<https://prettier.io/docs/en/options.html>ã€‚

## **4.3: è®¾ç½® `format` è„šæœ¬**

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `format` è„šæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
{
  "scripts": {
    "format": "prettier --write ."
  }
}
```

è¿™å°†ä½¿ç”¨ Prettier æ ¼å¼åŒ–é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶ã€‚

## **4.4: è¿è¡Œ `format` è„šæœ¬**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ ¼å¼åŒ–é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼š

```
npm run format
```

ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸€äº›æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–ã€‚æäº¤å®ƒä»¬ï¼š

```
git add .
git commit -m "Format code with Prettier"
```

## **4.5: è®¾ç½® `check-format` è„šæœ¬**

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `check-format` è„šæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
{
  "scripts": {
    "check-format": "prettier --check ."
  }
}
```

è¿™å°†æ£€æŸ¥é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶æ˜¯å¦å·²æ­£ç¡®æ ¼å¼åŒ–ã€‚

## **4.6: æ·»åŠ åˆ°æˆ‘ä»¬çš„ `CI` è„šæœ¬**

å°† `check-format` è„šæœ¬æ·»åŠ åˆ° `package.json` ä¸­çš„ `ci` è„šæœ¬ï¼š

```
{
  "scripts": {
    "ci": "npm run build && npm run check-format"
  }
}
```

è¿™å°†åœ¨ CI æµç¨‹ä¸­è¿è¡Œ `check-format` è„šæœ¬ã€‚

## **5: `exports`, `main` å’Œ `@arethetypeswrong/cli`**

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å®‰è£… `@arethetypeswrong/cli`ï¼Œè®¾ç½® `check-exports` è„šæœ¬ï¼Œè¿è¡Œ `check-exports` è„šæœ¬ï¼Œè®¾ç½® `main` å­—æ®µï¼Œå†æ¬¡è¿è¡Œ `check-exports` è„šæœ¬ï¼Œè®¾ç½® `ci` è„šæœ¬ï¼Œå¹¶è¿è¡Œ `ci` è„šæœ¬ã€‚

`@arethetypeswrong/cli` æ˜¯ä¸€ä¸ªæ£€æŸ¥ä½ çš„åŒ…å¯¼å‡ºæ˜¯å¦æ­£ç¡®çš„å·¥å…·ã€‚è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™äº›åœ°æ–¹å®¹æ˜“å‡ºé”™ï¼Œå¯èƒ½ä¼šç»™ä½¿ç”¨ä½ çš„åŒ…çš„äººå¸¦æ¥é—®é¢˜ã€‚

## **5.1: å®‰è£… `@arethetypeswrong/cli`**

è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… `@arethetypeswrong/cli`ï¼š

```
npm install --save-dev @arethetypeswrong/cli
```

## **5.2: è®¾ç½® `check-exports` è„šæœ¬**

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `check-exports` è„šæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
{
  "scripts": {
    "check-exports": "attw --pack ."
  }
}
```

è¿™å°†æ£€æŸ¥ä½ çš„åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ã€‚

## **5.3: è¿è¡Œ `check-exports` è„šæœ¬**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ä½ çš„åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ï¼š

```
npm run check-exports
```

ä½ åº”è¯¥ä¼šå‘ç°æœ‰å¤šä¸ªé”™è¯¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo"    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸ’€ Resolution failed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from CJS) â”‚ ğŸ’€ Resolution failed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from ESM) â”‚ ğŸ’€ Resolution failed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bundler           â”‚ ğŸ’€ Resolution failed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™è¡¨æ˜æ²¡æœ‰ Node çš„ç‰ˆæœ¬æˆ–ä»»ä½•æ‰“åŒ…å™¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„åŒ…ã€‚

è®©æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## **5.4: è®¾ç½® `main`**

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `main` å­—æ®µï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
{
  "main": "dist/index.js"
}
```

è¿™å‘Šè¯‰ Node åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°ä½ åŒ…çš„å…¥å£ç‚¹ã€‚

## **5.5: å†æ¬¡å°è¯• `check-exports`**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ä½ çš„åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ï¼š

```
npm run check-exports
```

ä½ åº”è¯¥åªä¼šæ³¨æ„åˆ°ä¸€ä¸ªè­¦å‘Šï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo"            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸŸ¢                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from CJS) â”‚ âš ï¸ ESM (dynamic import only) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from ESM) â”‚ ğŸŸ¢ (ESM)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bundler           â”‚ ğŸŸ¢                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™å‘Šè¯‰æˆ‘ä»¬æˆ‘ä»¬çš„åŒ…ä¸è¿è¡Œ ESM çš„ç³»ç»Ÿå…¼å®¹ã€‚ä½¿ç”¨ CJS çš„äººï¼ˆé€šå¸¸æ˜¯åœ¨æ—§ç³»ç»Ÿä¸­ï¼‰éœ€è¦ä½¿ç”¨åŠ¨æ€å¯¼å…¥æ¥å¯¼å…¥å®ƒã€‚

## **5.6 ä¿®å¤ CJS è­¦å‘Š**

å¦‚æœä½ ä¸æƒ³æ”¯æŒ CJSï¼ˆæˆ‘å»ºè®®è¿™æ ·åšï¼‰ï¼Œå°† `check-exports` è„šæœ¬æ›´æ”¹ä¸ºï¼š

```
{
  "scripts": {
    "check-exports": "attw --pack . --ignore-rules=cjs-resolves-to-esm"
  }
}
```

ç°åœ¨ï¼Œè¿è¡Œ `check-exports` å°†æ˜¾ç¤ºä¸€åˆ‡æ­£å¸¸ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo" â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸŸ¢                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from CJS) â”‚ ğŸŸ¢ (ESM)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from ESM) â”‚ ğŸŸ¢ (ESM)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bundler           â”‚ ğŸŸ¢                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¦‚æœä½ æƒ³åŒæ—¶å‘å¸ƒ CJS å’Œ ESM ä»£ç ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€æ­¥ã€‚

## **5.7: æ·»åŠ åˆ°æˆ‘ä»¬çš„ `CI` è„šæœ¬**

å°† `check-exports` è„šæœ¬æ·»åŠ åˆ° `package.json` ä¸­çš„ `ci` è„šæœ¬ï¼š

```
{
  "scripts": {
    "ci": "npm run build && npm run check-format && npm run check-exports"
  }
}
```

å¦‚æœä½ æƒ³åŒæ—¶å‘å¸ƒ CJS å’Œ ESM ä»£ç ï¼Œä½ å¯ä»¥ä½¿ç”¨ `tsup`ã€‚è¿™æ˜¯åŸºäº `esbuild` æ„å»ºçš„å·¥å…·ï¼Œå®ƒå¯ä»¥å°†ä½ çš„ TypeScript ä»£ç ç¼–è¯‘æˆä¸¤ç§æ ¼å¼ã€‚

æˆ‘ä¸ªäººçš„å»ºè®®æ˜¯è·³è¿‡è¿™ä¸€æ­¥ï¼Œåªå‘å¸ƒ ES æ¨¡å—ã€‚è¿™ä¼šæ˜¾è‘—ç®€åŒ–ä½ çš„è®¾ç½®ï¼Œå¹¶é¿å…è®¸å¤šåŒæ—¶å‘å¸ƒ CJS å’Œ ESM çš„é™·é˜±ï¼Œæ¯”å¦‚åŒåŒ…å±é™©ã€‚

ä½†å¦‚æœä½ æƒ³è¿™æ ·åšï¼Œè¯·ç»§ç»­ã€‚

## **6.1: å®‰è£… `tsup`**

è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… `tsup`ï¼š

```
npm install --save-dev tsup
```

## **6.2: åˆ›å»º `tsup.config.ts` æ–‡ä»¶**

åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ `tsup.config.ts` æ–‡ä»¶ï¼š

```
import { defineConfig } from "tsup";

export default defineConfig({
  entryPoints: ["src/index.ts"],
  format: ["cjs", "esm"],
  dts: true,
  outDir: "dist",
  clean: true,
});
```

- `entryPoints` æ˜¯ä½ çš„åŒ…çš„å…¥å£ç‚¹æ•°ç»„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ `src/index.ts`ã€‚
- `format` æ˜¯è¾“å‡ºæ ¼å¼çš„æ•°ç»„ã€‚æˆ‘ä»¬ä½¿ç”¨ `cjs`ï¼ˆCommonJSï¼‰å’Œ `esm`ï¼ˆECMAScript æ¨¡å—ï¼‰ã€‚
- `dts` æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå‘Šè¯‰ `tsup` ç”Ÿæˆå£°æ˜æ–‡ä»¶ã€‚
- `outDir` æ˜¯ç¼–è¯‘ä»£ç çš„è¾“å‡ºç›®å½•ã€‚
- `clean` å‘Šè¯‰ `tsup` åœ¨æ„å»ºä¹‹å‰æ¸…ç†è¾“å‡ºç›®å½•ã€‚

## **6.3: æ›´æ”¹ `build` è„šæœ¬**

å°† `package.json` ä¸­çš„ `build` è„šæœ¬æ›´æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š

```
{
  "scripts": {
    "build": "tsup"
  }
}
```

æˆ‘ä»¬ç°åœ¨å°†è¿è¡Œ `tsup` æ¥ç¼–è¯‘æˆ‘ä»¬çš„ä»£ç ï¼Œè€Œä¸æ˜¯ `tsc`ã€‚

ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å°†ç»§ç»­ç¿»è¯‘å‰©ä½™éƒ¨åˆ†ã€‚

## **6.4: æ·»åŠ  `exports` å­—æ®µ**

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `exports` å­—æ®µï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
{
  "exports": {
    "./package.json": "./package.json",
    ".": {
      "import": "./dist/index.js",
      "default": "./dist/index.cjs"
    }
  }
}
```

`exports` å­—æ®µå‘Šè¯‰ä½¿ç”¨ä½ åŒ…çš„ç¨‹åºå¦‚ä½•æ‰¾åˆ°ä½ çš„åŒ…çš„ CJS å’Œ ESM ç‰ˆæœ¬ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æŒ‡å¼•ä½¿ç”¨ `import` çš„äººåˆ° `dist/index.js`ï¼Œä½¿ç”¨ `require` çš„äººåˆ° `dist/index.cjs`ã€‚

è¿˜å»ºè®®å°† `./package.json` æ·»åŠ åˆ° `exports` å­—æ®µã€‚è¿™æ˜¯å› ä¸ºæŸäº›å·¥å…·éœ€è¦è½»æ¾è®¿é—®ä½ çš„ `package.json` æ–‡ä»¶ã€‚

## **6.5: å†æ¬¡å°è¯• `check-exports`**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ä½ çš„åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ï¼š

```
npm run check-exports
```

ç°åœ¨ï¼Œä¸€åˆ‡åº”è¯¥éƒ½æ˜¯ç»¿è‰²çš„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo" â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸŸ¢                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from CJS) â”‚ ğŸŸ¢ (CJS)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from ESM) â”‚ ğŸŸ¢ (ESM)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bundler           â”‚ ğŸŸ¢                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## **6.6: å°† TypeScript è½¬ä¸º linter**

æˆ‘ä»¬ä¸å†è¿è¡Œ `tsc` æ¥ç¼–è¯‘ä»£ç ã€‚è€Œä¸” `tsup` å®é™…ä¸Šå¹¶ä¸æ£€æŸ¥ä»£ç ä¸­çš„é”™è¯¯ - å®ƒåªæ˜¯å°†å…¶è½¬æ¢ä¸º JavaScriptã€‚

è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬çš„ä»£ç ä¸­æœ‰ TypeScript é”™è¯¯ï¼Œæˆ‘ä»¬çš„ `ci` è„šæœ¬ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚å“å‘€ã€‚

è®©æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

### **6.6.1: åœ¨ `tsconfig.json` ä¸­æ·»åŠ  `noEmit`**

åœ¨ `tsconfig.json` ä¸­æ·»åŠ ä¸€ä¸ª `noEmit` å­—æ®µï¼š

```
{
  "compilerOptions": {
    // ...å…¶ä»–é€‰é¡¹
    "noEmit": true
  }
}
```

### **6.6.2: ä» `tsconfig.json` ä¸­ç§»é™¤æœªä½¿ç”¨çš„å­—æ®µ**

ä»ä½ çš„ `tsconfig.json` ä¸­ç§»é™¤ä»¥ä¸‹å­—æ®µï¼š

- `outDir`
- `rootDir`
- `sourceMap`
- `declaration`
- `declarationMap`

åœ¨æˆ‘ä»¬æ–°çš„ 'linting' è®¾ç½®ä¸­ä¸å†éœ€è¦å®ƒä»¬ã€‚

### **6.6.3: å°† `module` æ›´æ”¹ä¸º `Preserve`**

å¯é€‰åœ°ï¼Œä½ ç°åœ¨å¯ä»¥å°† `tsconfig.json` ä¸­çš„ `module` æ›´æ”¹ä¸º `Preserve`ï¼š

```
{
  "compilerOptions": {
    // ...å…¶ä»–é€‰é¡¹
    "module": "Preserve"
  }
}
```

è¿™æ„å‘³ç€ä½ ä¸å†éœ€è¦ä½¿ç”¨ `.js` æ‰©å±•åæ¥å¯¼å…¥ä½ çš„æ–‡ä»¶ã€‚è¿™æ„å‘³ç€ `index.ts` å¯ä»¥è¿™æ ·å†™ï¼š

```
export * from "./utils";
```

### **6.6.4: æ·»åŠ  `lint` è„šæœ¬**

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `lint` è„šæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
{
  "scripts": {
    "lint": "tsc"
  }
}
```

è¿™å°†ä½¿ç”¨ TypeScript ä½œä¸º linter è¿è¡Œã€‚

### **6.6.5: å°† `lint` æ·»åŠ åˆ°ä½ çš„ `ci` è„šæœ¬**

å°† `lint` è„šæœ¬æ·»åŠ åˆ° `package.json` ä¸­çš„ `ci` è„šæœ¬ï¼š

```
{
  "scripts": {
    "ci": "npm run build && npm run check-format && npm run check-exports && npm run lint"
  }
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬çš„ CI æµç¨‹ä¸­å°†åŒ…æ‹¬ TypeScript é”™è¯¯ã€‚

## **7.1: å®‰è£… `vitest`**

è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… `vitest`ï¼š

```
npm install --save-dev vitest
```

## **7.2: åˆ›å»ºæµ‹è¯•**

åˆ›å»ºä¸€ä¸ªåä¸º `src/utils.test.ts` çš„æ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
import { add } from "./utils";
import { test, expect } from "vitest";

test("add", () => {
  expect(add(1, 2)).toBe(3);
});
```

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œæ£€æŸ¥ `add` å‡½æ•°æ˜¯å¦è¿”å›æ­£ç¡®çš„å€¼ã€‚

## **7.3: è®¾ç½® `test` è„šæœ¬**

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `test` è„šæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
{
  "scripts": {
    "test": "vitest run"
  }
}
```

`vitest run` ä¼šä¸€æ¬¡æ€§è¿è¡Œé¡¹ç›®ä¸­çš„æ‰€æœ‰æµ‹è¯•ï¼Œä¸è¿›å…¥ç›‘è§†æ¨¡å¼ã€‚

## **7.4: è¿è¡Œ `test` è„šæœ¬**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è¿è¡Œä½ çš„æµ‹è¯•ï¼š

```
npm run test
```

ä½ åº”è¯¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```
âœ“ src/utils.test.ts (1)
   âœ“ add

æµ‹è¯•æ–‡ä»¶ 1 ä¸ªé€šè¿‡ (1)
    æµ‹è¯•ç”¨ä¾‹ 1 ä¸ªé€šè¿‡ (1)
```

è¿™è¡¨æ˜ä½ çš„æµ‹è¯•å·²æˆåŠŸé€šè¿‡ã€‚

## **7.5: è®¾ç½® `dev` è„šæœ¬**

ä¸€ç§å¸¸è§çš„å·¥ä½œæµç¨‹æ˜¯åœ¨å¼€å‘æ—¶ä»¥ç›‘è§†æ¨¡å¼è¿è¡Œæµ‹è¯•ã€‚åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `dev` è„šæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
{
  "scripts": {
    "dev": "vitest"
  }
}
```

è¿™å°†ä»¥ç›‘è§†æ¨¡å¼è¿è¡Œä½ çš„æµ‹è¯•ã€‚

## **7.6: æ·»åŠ åˆ°æˆ‘ä»¬çš„ `CI` è„šæœ¬**

å°† `test` è„šæœ¬æ·»åŠ åˆ° `package.json` ä¸­çš„ `ci` è„šæœ¬ï¼š

```
{
  "scripts": {
    "ci": "npm run build && npm run check-format && npm run check-exports && npm run lint && npm run test"
  }
}
```

## **8.1: åˆ›å»ºæˆ‘ä»¬çš„å·¥ä½œæµç¨‹**

åˆ›å»ºä¸€ä¸ª `.github/workflows/ci.yml` æ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```
name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run CI
        run: npm run ci
```

è¿™ä¸ªæ–‡ä»¶æ˜¯ GitHub ç”¨æ¥è¿è¡Œä½ çš„ CI æµç¨‹çš„æŒ‡ä»¤ã€‚

- `name` æ˜¯å·¥ä½œæµç¨‹çš„åç§°ã€‚
- `on` æŒ‡å®šäº†å·¥ä½œæµç¨‹åº”è¯¥ä½•æ—¶è¿è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåœ¨æ‹‰å–è¯·æ±‚å’Œæ¨é€åˆ° `main` åˆ†æ”¯æ—¶è¿è¡Œã€‚
- `concurrency` é˜²æ­¢å¤šä¸ªå·¥ä½œæµç¨‹å®ä¾‹åŒæ—¶è¿è¡Œï¼Œä½¿ç”¨ `cancel-in-progress` å–æ¶ˆä»»ä½•æ­£åœ¨è¿›è¡Œçš„è¿è¡Œã€‚
- `jobs` æ˜¯ä¸€ç»„è¦è¿è¡Œçš„å·¥ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º `ci` çš„å·¥ä½œã€‚
- `actions/checkout@v4` ä»ä»“åº“æ£€å‡ºä»£ç ã€‚
- `actions/setup-node@v4` è®¾ç½® Node.js å’Œ npmã€‚
- `npm install` å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚
- `npm run ci` è¿è¡Œé¡¹ç›®çš„ CI è„šæœ¬ã€‚

å¦‚æœæˆ‘ä»¬çš„ CI æµç¨‹çš„ä»»ä½•éƒ¨åˆ†å¤±è´¥ï¼Œå·¥ä½œæµç¨‹å°†å¤±è´¥ï¼ŒGitHub ä¼šé€šè¿‡åœ¨æäº¤æ—è¾¹æ˜¾ç¤ºä¸€ä¸ªçº¢è‰²çš„å‰æ¥é€šçŸ¥æˆ‘ä»¬ã€‚

## **8.2: æµ‹è¯•æˆ‘ä»¬çš„å·¥ä½œæµç¨‹**

å°†æ›´æ”¹æ¨é€åˆ° GitHubï¼Œå¹¶åœ¨ä»“åº“çš„ Actions é€‰é¡¹å¡ä¸­æ£€æŸ¥ã€‚ä½ åº”è¯¥çœ‹åˆ°ä½ çš„å·¥ä½œæµç¨‹æ­£åœ¨è¿è¡Œã€‚

è¿™å°†åœ¨å¯¹å­˜å‚¨åº“è¿›è¡Œçš„æ¯æ¬¡æäº¤å’Œæ¯æ¬¡ PR æ—¶ç»™å‡ºè­¦å‘Šã€‚

## **9.1: å®‰è£… `@changesets/cli`**

è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆå§‹åŒ– Changesetsï¼š

```
npm install --save-dev @changesets/cli
```

## **9.2: åˆå§‹åŒ– Changesets**

è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆå§‹åŒ– Changesetsï¼š

```
npx changeset init
```

è¿™å°†åœ¨ä½ çš„é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ª `.changeset` æ–‡ä»¶å¤¹ï¼ŒåŒ…å«ä¸€ä¸ª `config.json` æ–‡ä»¶ã€‚è¿™ä¹Ÿæ˜¯ä½ çš„ changeset å°†å­˜æ”¾çš„åœ°æ–¹ã€‚

## **9.3: ä½¿ changeset å‘å¸ƒå…¬å¼€**

åœ¨ `.changeset/config.json` ä¸­ï¼Œå°† `access` å­—æ®µæ›´æ”¹ä¸º `public`ï¼š

```
// .changeset/config.json
{
  "access": "public"
}
```

å¦‚æœä¸æ›´æ”¹æ­¤å­—æ®µï¼Œ`changesets` ä¸ä¼šå°†ä½ çš„åŒ…å‘å¸ƒåˆ° npmã€‚

## **9.4: å°† `commit` è®¾ç½®ä¸º `true`ï¼š**

åœ¨ `.changeset/config.json` ä¸­ï¼Œå°† `commit` å­—æ®µæ›´æ”¹ä¸º `true`ï¼š

```
// .changeset/config.json
{
  "commit": true
}
```

è¿™å°†åœ¨ç‰ˆæœ¬æ§åˆ¶åå°† changeset æäº¤åˆ°ä½ çš„ä»“åº“ã€‚

## **9.5: è®¾ç½®æœ¬åœ°å‘å¸ƒè„šæœ¬ï¼ˆç»­ï¼‰**

```
{
  "scripts": {
    "local-release": "changeset version && changeset publish"
  }
}
```

è¿™ä¸ªè„šæœ¬å°†è¿è¡Œ CI æµç¨‹ï¼Œç„¶åå‘å¸ƒä½ çš„åŒ…åˆ° npmã€‚è¿™æ˜¯å½“ä½ æƒ³ä»æœ¬åœ°æœºå™¨å‘å¸ƒæ–°ç‰ˆæœ¬çš„åŒ…æ—¶è¿è¡Œçš„å‘½ä»¤ã€‚

## **9.6: åœ¨ `prepublishOnly` ä¸­è¿è¡Œ CIï¼ˆç»­ï¼‰**

```
{
  "scripts": {
    "prepublishOnly": "npm run ci"
  }
}
```

è¿™å°†ç¡®ä¿åœ¨å°†åŒ…å‘å¸ƒåˆ° npm ä¹‹å‰è‡ªåŠ¨è¿è¡Œ CI æµç¨‹ã€‚

## **9.7: æ·»åŠ ä¸€ä¸ªæ›´æ”¹é›†**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ·»åŠ ä¸€ä¸ªæ›´æ”¹é›†ï¼š

```
npx changeset
```

è¿™å°†æ‰“å¼€ä¸€ä¸ªäº¤äº’å¼æç¤ºï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªæ›´æ”¹é›†ã€‚æ›´æ”¹é›†æ˜¯ä¸€ç§å°†æ›´æ”¹åˆ†ç»„å¹¶èµ‹äºˆå®ƒä»¬ç‰ˆæœ¬å·çš„æ–¹å¼ã€‚

å°†æ­¤ç‰ˆæœ¬æ ‡è®°ä¸º `patch`ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæè¿°ï¼Œå¦‚â€œåˆå§‹å‘å¸ƒâ€ã€‚

è¿™å°†åœ¨ `.changeset` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ›´æ”¹é›†æ–‡ä»¶ã€‚

## **9.8: æäº¤ä½ çš„æ›´æ”¹**

å°†æ›´æ”¹æäº¤åˆ°ä½ çš„ä»“åº“ï¼š

```
git add .
git commit -m "Prepare for initial release"
```

## **9.9: è¿è¡Œæœ¬åœ°å‘å¸ƒè„šæœ¬**

è¿è¡Œä»¥ä¸‹å‘½ä»¤å‘å¸ƒä½ çš„åŒ…ï¼š

```
npm run local-release
```

è¿™å°†è¿è¡Œ CI æµç¨‹ï¼Œå¯¹ä½ çš„åŒ…è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œå¹¶å°†å…¶å‘å¸ƒåˆ° npmã€‚

å®ƒè¿˜å°†åœ¨ä½ çš„ä»“åº“ä¸­åˆ›å»ºä¸€ä¸ª `CHANGELOG.md` æ–‡ä»¶ï¼Œè¯¦ç»†è®°å½•æ­¤ç‰ˆæœ¬ä¸­çš„æ›´æ”¹ã€‚æ¯æ¬¡ä½ å‘å¸ƒæ—¶ï¼Œè¿™éƒ½ä¼šæ›´æ–°ã€‚

## **9.10: åœ¨ npm ä¸ŠæŸ¥çœ‹ä½ çš„åŒ…**

è®¿é—®ä»¥ä¸‹ç½‘å€æŸ¥çœ‹ä½ çš„åŒ…ï¼š

```
http://npmjs.com/package/<your-package-name>
```

ä½ åº”è¯¥èƒ½å¤Ÿåœ¨é‚£é‡Œçœ‹åˆ°ä½ çš„åŒ…ï¼ä½ åšåˆ°äº†ï¼ä½ å·²ç»æˆåŠŸåœ°å‘å¸ƒåˆ°äº† npmï¼

## **æ€»ç»“**

ç°åœ¨ï¼Œä½ å·²ç»å®Œå…¨è®¾ç½®å¥½äº†ä½ çš„åŒ…ã€‚ä½ å·²ç»è®¾ç½®äº†ï¼š

- ä¸€ä¸ªå¸¦æœ‰æœ€æ–°è®¾ç½®çš„ TypeScript é¡¹ç›®
- Prettierï¼Œæ—¢å¯ä»¥æ ¼å¼åŒ–ä½ çš„ä»£ç ï¼Œä¹Ÿå¯ä»¥æ£€æŸ¥å®ƒæ˜¯å¦æ­£ç¡®æ ¼å¼åŒ–
- `@arethetypeswrong/cli`ï¼Œæ£€æŸ¥ä½ çš„åŒ…çš„å¯¼å‡ºæ˜¯å¦æ­£ç¡®
- `tsup`ï¼Œå°†ä½ çš„ TypeScript ä»£ç ç¼–è¯‘æˆ JavaScript
- `vitest`ï¼Œè¿è¡Œä½ çš„æµ‹è¯•
- GitHub Actionsï¼Œè¿è¡Œä½ çš„ CI æµç¨‹
- Changesetsï¼Œå¸®åŠ©ä½ çš„åŒ…è¿›è¡Œç‰ˆæœ¬æ§åˆ¶å’Œå‘å¸ƒ

github è¿˜æ”¯æŒè®¾ç½® Changesets GitHub æ“ä½œå’Œ PR æœºå™¨äººï¼Œå¯ä»¥æ›´å¥½çš„å®ç°è‡ªåŠ¨åŒ–ã€‚
