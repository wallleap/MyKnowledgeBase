---
title: 007-实战快速开发接口
date: 2025-03-14T11:48:25+08:00
updated: 2025-03-18T11:36:15+08:00
dg-publish: false
---

## 分类接口

### 使用种子文件添加默认数据

创建种子文件

```sh
sequelize seed:generate --name category
```

修改种子文件

```js
'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up (queryInterface, Sequelize) {
    /**
     * Add seed commands here.
     *
     * Example:
     * await queryInterface.bulkInsert('People', [{
     *   name: 'John Doe',
     *   isBetaMember: false
     * }], {});
    */
    await queryInterface.bulkInsert('Categories', [      {
      name: '编程语言',
      rank: 1,
      createdAt: new Date(),
      updatedAt: new Date()
    },
    {
      name: '数据科学',
      rank: 2,
      createdAt: new Date(),
      updatedAt: new Date()
    },
    {
      name: '人工智能',
      rank: 3,
      createdAt: new Date(),
      updatedAt: new Date()
    },
    {
      name: '前端开发',
      rank: 4,
      createdAt: new Date(),
      updatedAt: new Date()
    },
    {
      name: '后端开发',
      rank: 5,
      createdAt: new Date(),
      updatedAt: new Date()
    }], {});
  },

  async down (queryInterface, Sequelize) {
    /**
     * Add commands to revert seed here.
     *
     * Example:
     * await queryInterface.bulkDelete('People', null, {});
     */
  }
};
```

运行命令

```sh
sequelize db:seed --seed 20250314035825-category
```

### 修改模型增加验证

`models/category.js`

```js
'use strict';
const {
  Model
} = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class Category extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {
      // define association here
    }
  }
  Category.init({
    name: {
      type: DataTypes.STRING,
      allowNull: false,
      unique: { args: true, msg: '分类名称已存在' },
      validate: {
        notNull: {
          msg: '分类名称必须填写'
        },
        notEmpty: {
          msg: '分类名称不能为空'
        },
        len: {
          args: [2, 45],
          msg: '分类名称长度需要在2到45个字符之间'
        }
      }
    },
    rank: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        notNull: {
          msg: '排序必须填写'
        },
        notEmpty: {
          msg: '排序不能为空'
        },
        isInt: {
          msg: '排序必须为整数'
        },
        ifPositiveInteger(value) {
          if (value <= 0) {
            throw new Error('排序必须为正整数')
          }
        }
      }
    }
  }, {
    sequelize,
    modelName: 'Category',
  });
  return Category;
};
```

### 路由

直接复制 articles.js 粘贴，替换

`routes/admin/categories.js`

```js
const express = require('express')
const router = express.Router()
const { Category } = require('../../models')
const { Op } = require('sequelize')
const {
  NotFoundError,
  success,
  failure
} = require('../../utils/response')

/**
 * 查询分类列表
 * GET /admin/Category
 */
router.get('/', async function(req, res, next) {
  try {
    const query = req.query
    const page = Math.abs(Number(query.page)) || 1
    const pageSize = Math.abs(Number(query.pageSize)) || 10
    const offset = (page - 1) * pageSize
    const condition = {
      order: [['rank', 'ASC'], ['id', 'ASC']],  // 先按 rank 排序，如果 rank 相同再按 id 排序
      limit: pageSize,
      offset
    }
    if (query.name) {
      condition.where = {
        name: {
          [Op.like]: `%${query.name}%`
        }
      }
    }

    const { rows: category, count: total } = await Category.findAndCountAll(condition)
    success(res, '查询分类列表成功', {
      pagination: { page, pageSize, total },
      category
    })
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 查询分类详情
 * GET /admin/Category/:id
 */
router.get('/:id', async function(req, res, next) {
  try {
    const category = await getCategory(req)
    success(res, '查询分类详情成功', { category })
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 创建分类
 * POST /admin/Category
 */
router.post('/', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const category = await Category.create(body)
    success(res, '创建分类成功', { category }, 201)
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 删除分类
 * DELETE /admin/Category/:id
 */
router.delete('/:id', async function(req, res, next) {
  try {
    const Category = await getCategory(req)
    await Category.destroy()
    success(res, '删除分类成功', null)
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 更新分类
 * PUT /admin/Category/:id
 */
router.put('/:id', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const Category = await getCategory(req)
    await Category.update(body)
    success(res, '更新分类成功', { Category })
  } catch (error) {
    failure(res, error)
  }
})

/** 
 * 公共方法 查询当前分类
 * @param {Object} req - 请求
 * @returns {Object} - 当前分类
 */
async function getCategory(req) {
  const { id } = req.params
  const category = await Category.findByPk(id)

  if (!category) {
    throw new NotFoundError(`ID 为 ${id} 的分类未找到`)
  }

  return category
}

/**
 * 公共方法 白名单过滤
 * @param {Object} req - 请求
 * @returns {{name: String, rank: Number}} - 过滤后的参数
 */
function filterBody(req) {
  return {
    name: req.body.name,
    rank: req.body.rank
  }
}

module.exports = router
```

`app.js` 中添加

```js
const adminCategoriesRouter = require('./routes/admin/categories')

app.use('/admin/categories', adminCategoriesRouter)
```

## 设置接口

### 种子文件

生成种子文件

```sh
sequelize seed:generate --name setting
```

修改

```js
'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up (queryInterface, Sequelize) {
    await queryInterface.bulkInsert('Settings', [
      {
        name: 'site_name',
        icp: 'ICP 11000000',
        copyright: 'Copyright © 2023',
        createdAt: new Date(),
        updatedAt: new Date()
      }
    ])
  },

  async down (queryInterface, Sequelize) {
    /**
     * Add commands to revert seed here.
     *
     * Example:
     * await queryInterface.bulkDelete('People', null, {});
     */
  }
};
```

复制文件名，运行种子命令

```sh
sequelize db:seed --seed 20250314043503-setting
```

### 路由

`routes/admin/settings.js`

```js
const express = require('express')
const router = express.Router()
const { Setting } = require('../../models')
const {
  NotFoundError,
  success,
  failure
} = require('../../utils/response')

/**
 * 查询系统设置
 * GET /admin/settings
 */
router.get('/', async function(req, res, next) {
  try {
    const setting = await getSetting()
    success(res, '查询系统设置详情成功', { setting})
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 更新系统设置
 * PUT /admin/settings
 */
router.put('/', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const setting = await getSetting()
    await setting.update(body)
    success(res, '更新系统设置成功', { setting })
  } catch (error) {
    failure(res, error)
  }
})

/** 
 * 公共方法 查询当前系统设置
 * @param {Object} req - 请求
 * @returns {Object} - 当前系统设置
 */
async function getSetting() {
  const setting = await Setting.findOne()

  if (!setting) {
    throw new NotFoundError(`初始系统设置未找到，请运行种子文件`)
  }

  return setting
}

/**
 * 公共方法 白名单过滤
 * @param {Object} req - 请求
 * @returns {{name: string, icp: string, copyright: string}} - 过滤后的参数
 */
function filterBody(req) {
  return {
    name: req.body.name,
    icp: req.body.icp,
    copyright: req.body.copyright,
  }
}

module.exports = router
```

`app.js`

```js
const express = require('express')
const path = require('path')
const cookieParser = require('cookie-parser')
const logger = require('morgan')

const indexRouter = require('./routes/index')
const usersRouter = require('./routes/users')

// Admin Routes
const adminArticlesRouter = require('./routes/admin/articles')
const adminCategoriesRouter = require('./routes/admin/categories')
const adminSettingsRouter = require('./routes/admin/settings')

const app = express()

app.use(logger('dev'))
app.use(express.json())
app.use(express.urlencoded({ extended: false }))
app.use(cookieParser())
app.use(express.static(path.join(__dirname, 'public')))

app.use('/', indexRouter)
app.use('/users', usersRouter)

// Admin Routes
app.use('/admin/articles', adminArticlesRouter)
app.use('/admin/categories', adminCategoriesRouter)
app.use('/admin/settings', adminSettingsRouter)

module.exports = app
```

## 用户接口

### 添加字段

例如需要给用户添加一个 phone 字段

```sh
sequelize migration:create --name add-phone-to-user
```

迁移文件

```js
'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up (queryInterface, Sequelize) {
    await queryInterface.addColumn('Users', 'phone', {
      type: Sequelize.STRING,
      allowNull: true,
    });
  },

  async down (queryInterface, Sequelize) {
    await queryInterface.removeColumn('Users', 'phone');
  }
};
```

运行迁移命令

```sh
sequelize db:migrate
```

到模型中手动添加字段

```js
'use strict';
const {
  Model
} = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class User extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {
      // define association here
    }
  }
  User.init({
    email: DataTypes.STRING,
    username: DataTypes.STRING,
    password: DataTypes.STRING,
    nickname: DataTypes.STRING,
    sex: DataTypes.TINYINT,
    company: DataTypes.STRING,
    introduce: DataTypes.TEXT,
    role: DataTypes.TINYINT,
    phone: DataTypes.STRING,
  }, {
    sequelize,
    modelName: 'User',
  });
  return User;
};
```

同样方式添加 avatar 字段

### 种子文件

```sh
sequelize seed:generate --name user
```

修改

```js
'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up (queryInterface, Sequelize) {
    await queryInterface.bulkInsert('Users', [{
      email: 'admin@admin.com',
      username: 'admin',
      password: 'Password@123456',
      nickname: '超级管理员',
      sex: 1,
      role: 100,
      createdAt: new Date(),
      updatedAt: new Date()
    }, {
      email: 'user@user.com',
      username: 'user',
      password: 'Password@123456',
      nickname: '普通用户',
      sex: 2,
      role: 0,
      company: '公司',
      introduce: '介绍',
      phone: '13324561789',
      createdAt: new Date(),
      updatedAt: new Date()
    },{
      email: 'user2@user.com',
      username: 'user2',
      password: 'Password@123456',
      nickname: '普通用户2',
      sex: 9,
      role: 0,
      createdAt: new Date(),
      updatedAt: new Date()
    }], {});
  },

  async down (queryInterface, Sequelize) {
    /**
     * Add commands to revert seed here.
     *
     * Example:
     * await queryInterface.bulkDelete('People', null, {});
     */
  }
};
```

运行

```sh
sequelize db:seed --seed 20250314045857-user
```

### 模型验证

`models/user.js`

```js
'use strict';
const {
  Model
} = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class User extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {
      // define association here
    }
  }
  User.init({
    email: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '邮箱必须填写'
        },
        notEmpty: {
          msg: '邮箱不能为空'
        },
        isEmail: {
          msg: '邮箱格式不正确'
        },
        async unique(value) {
          const user = await User.findOne({
            where: {
              email: value
            }
          })
          if (user) {
            throw new Error('邮箱已经存在，请直接登录')
          }
        }
      }
    },
    username: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '用户名必须填写'
        },
        notEmpty: {
          msg: '用户名不能为空'
        },
        len: {
          args: [2, 45],
          msg: '用户名长度需要在2到45个字符之间'
        },
        async uniqueUsername(value) {
          const user = await User.findOne({
            where: {
              username: value
            }
          })
          if (user) {
            throw new Error('用户名已存在，请修改为其他用户名')
          }
        },
      }
    },
    password: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '密码必须填写'
        },
        notEmpty: {
          msg: '密码不能为空'
        },
        len: {
          args: [6, 45],
          msg: '密码长度需要在6到45个字符之间'
        },
        async validatePassword(value) {
          const reg = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[^]{6,45}$/
          if (!reg.test(value)) {
            throw new Error('密码必须包含数字、大小写字母')
          }
        },
      },
    },
    nickname: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '昵称必须填写'
        },
        notEmpty: {
          msg: '昵称不能为空'
        },
        len: {
          args: [2, 45],
          msg: '昵称长度需要在2到45个字符之间'
        },
      }
    },
    sex: {
      type: DataTypes.TINYINT,
      allowNull: false,
      validate: {
        notNull: {
          msg: '性别必须填写'
        },
        notEmpty: {
          msg: '性别不能为空'
        },
        isIn: {
          args: [[0, 1, 2]],
          msg: '性别的值必须是 男：0、女：1、未选择：2'
        },
      }
    },
    company: DataTypes.STRING,
    introduce: DataTypes.TEXT,
    role: {
      type: DataTypes.TINYINT,
      allowNull: false,
      validate: {
        notNull: {
          msg: '用户组必须选择'
        },
        notEmpty: {
          msg: '用户组不能为空'
        },
        isIn: {
          args: [[0, 100]],
          msg: '用户组的值必须是 管理员：100、普通用户：0'
        },
      }
    },
    phone: {
      type: DataTypes.STRING,
      validate: {
        is: {
          args: /^1[3-9]\d{9}$/,
          msg: '手机号码格式不正确'
        },
      }
    },
    avatar: {
      type: DataTypes.STRING,
      validate: {
        isUrl: {
          msg: '头像地址格式不正确'
        },
      }
    },
  }, {
    sequelize,
    modelName: 'User',
  });
  return User;
};
```

### 路由

`routes/admin/users.js`

```js
const express = require('express')
const router = express.Router()
const { User } = require('../../models')
const { Op } = require('sequelize')
const {
  NotFoundError,
  success,
  failure
} = require('../../utils/response')
const user = require('../../models/user')
const e = require('express')

/**
 * 查询用户列表
 * GET /admin/users
 */
router.get('/', async function(req, res, next) {
  try {
    const query = req.query
    const page = Math.abs(Number(query.page)) || 1
    const pageSize = Math.abs(Number(query.pageSize)) || 10
    const offset = (page - 1) * pageSize
    const condition = {
      order: [['id', 'DESC']],
      limit: pageSize,
      offset
    }
    if (query.email) {
      condition.where = {
        email: {
          [Op.eq]: query.email
        }
      }
    }
    if (query.username) {
      condition.where = {
        username: {
          [Op.eq]: query.username
        }
      }
    }
    if (query.nickname) {
      condition.where = {
        nickname: {
          [Op.like]: `%${query.nickname}%`
        }
      }
    }
    if (query.role) {
      condition.where = {
        role: {
          [Op.eq]: query.role
        }
      }
    }

    const { rows: users, count: total } = await User.findAndCountAll(condition)
    success(res, '查询用户列表成功', {
      pagination: { page, pageSize, total },
      users
    })
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 查看用户信息
 * GET /admin/users/:id
 */
router.get('/:id', async function(req, res, next) {
  try {
    const user = await getUser(req)
    success(res, '查询用户详情成功', { user})
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 创建用户
 * POST /admin/users
 */
router.post('/', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const user = await User.create(body)
    success(res, '创建用户成功', { user }, 201)
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 更新用户信息
 * PUT /admin/users/:id
 */
router.put('/:id', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const user = await getUser(req)
    await user.update(body)
    success(res, '更新用户成功', { user })
  } catch (error) {
    failure(res, error)
  }
})

/** 
 * 公共方法 查询当前用户
 * @param {Object} req - 请求
 * @returns {Object} - 当前用户
 */
async function getUser(req) {
  const { id } = req.params
  const user = await User.findByPk(id)

  if (!user) {
    throw new NotFoundError(`ID 为 ${id} 的用户未找到`)
  }

  return user
}

/**
 * 公共方法 白名单过滤
 * @param {Object} req - 请求
 * @returns {Object} - 过滤后的参数
 */
function filterBody(req) {
  return {
    email: req.body.email,
    username: req.body.username,
    password: req.body.password,
    nickname: req.body.nickname,
    sex: req.body.sex,
    company: req.body.company,
    introduce: req.body.introduce,
    role: req.body.role,
    phone: req.body.phone,
    avatar: req.body.avatar,
  }
}

module.exports = router
```

`app.js`

```js
const adminUsersRouter = require('./routes/admin/users')

app.use('/admin/users', adminUsersRouter)
```

### 使用 bcryptjs 加密数据

密码现在是密文存储的，这样很不安全，需要进行加密存储，这样泄露了也不要紧

<https://www.npmjs.com/package/bcryptjs>

安装

```sh
npm install bcryptjs
```

在模型中进行加密

```js
'use strict';
const {
  Model
} = require('sequelize');
const bcrypt = require('bcryptjs')

module.exports = (sequelize, DataTypes) => {
  class User extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {
      // define association here
    }
  }
  User.init({
    email: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '邮箱必须填写'
        },
        notEmpty: {
          msg: '邮箱不能为空'
        },
        isEmail: {
          msg: '邮箱格式不正确'
        },
        async unique(value) {
          const user = await User.findOne({
            where: {
              email: value
            }
          })
          if (user) {
            throw new Error('邮箱已经存在，请直接登录')
          }
        }
      }
    },
    username: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '用户名必须填写'
        },
        notEmpty: {
          msg: '用户名不能为空'
        },
        len: {
          args: [2, 45],
          msg: '用户名长度需要在2到45个字符之间'
        },
        async uniqueUsername(value) {
          const user = await User.findOne({
            where: {
              username: value
            }
          })
          if (user) {
            throw new Error('用户名已存在，请修改为其他用户名')
          }
        },
      }
    },
    password: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '密码必须填写'
        },
        notEmpty: {
          msg: '密码不能为空'
        },
      },
      set(value) {
        if (value.length < 6 || value.length > 45) {
          throw new Error('密码长度需要在6到45个字符之间')
        }
        if (!value.match(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[^]{6,45}$/)) {
          throw new Error('密码必须包含数字、大小写字母')
        }
        const hash = bcrypt.hashSync(value, 10)
        this.setDataValue('password', hash)
      }
    },
    nickname: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '昵称必须填写'
        },
        notEmpty: {
          msg: '昵称不能为空'
        },
        len: {
          args: [2, 45],
          msg: '昵称长度需要在2到45个字符之间'
        },
      }
    },
    sex: {
      type: DataTypes.TINYINT,
      allowNull: false,
      validate: {
        notNull: {
          msg: '性别必须填写'
        },
        notEmpty: {
          msg: '性别不能为空'
        },
        isIn: {
          args: [[0, 1, 2]],
          msg: '性别的值必须是 男：0、女：1、未选择：2'
        },
      }
    },
    company: DataTypes.STRING,
    introduce: DataTypes.TEXT,
    role: {
      type: DataTypes.TINYINT,
      allowNull: false,
      validate: {
        notNull: {
          msg: '用户组必须选择'
        },
        notEmpty: {
          msg: '用户组不能为空'
        },
        isIn: {
          args: [[0, 100]],
          msg: '用户组的值必须是 管理员：100、普通用户：0'
        },
      }
    },
    phone: {
      type: DataTypes.STRING,
      validate: {
        is: {
          args: /^1[3-9]\d{9}$/,
          msg: '手机号码格式不正确'
        },
      }
    },
    avatar: {
      type: DataTypes.STRING,
      validate: {
        isUrl: {
          msg: '头像地址格式不正确'
        },
      }
    },
  }, {
    sequelize,
    modelName: 'User',
  });
  return User;
};
```

修改种子文件

```js
'use strict';

const bcrypt = require('bcryptjs');

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up (queryInterface, Sequelize) {
    await queryInterface.bulkInsert('Users', [{
      email: 'admin@admin.com',
      username: 'admin',
      password: bcrypt.hashSync('Password@123456', 10),
      nickname: '超级管理员',
      sex: 1,
      role: 100,
      createdAt: new Date(),
      updatedAt: new Date()
    }, {
      email: 'user@user.com',
      username: 'user',
      password: bcrypt.hashSync('Password@123456', 10),
      nickname: '普通用户',
      sex: 2,
      role: 0,
      company: '公司',
      introduce: '介绍',
      phone: '13324561789',
      createdAt: new Date(),
      updatedAt: new Date()
    },{
      email: 'user2@user.com',
      username: 'user2',
      password: bcrypt.hashSync('Password@123456', 10),
      nickname: '普通用户2',
      sex: 9,
      role: 0,
      createdAt: new Date(),
      updatedAt: new Date()
    }], {});
  },

  async down (queryInterface, Sequelize) {
    /**
     * Add commands to revert seed here.
     *
     * Example:
     * await queryInterface.bulkDelete('People', null, {});
     */
  }
};
```

把数据库 Users 表清空后重新运行种子文件

```sh
sequelize db:seed --seed 20250314045857-user
```

登录的时候比较密码

```js
bcrypt.compareSync("B4c0/\/", hash); // true
```

## 课程接口

### 种子文件

```sh
sequelize seed:generate --name course
```

修改文件

```js
'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up (queryInterface, Sequelize) {
    await queryInterface.bulkInsert('Courses', [
      {
        categoryId: 4,
        userId: 1,
        name: 'React',
        recommended: true,
        introductory: true,
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        categoryId: 5,
        userId: 1,
        name: 'Node.js',
        recommended: true,
        introductory: true,
        createdAt: new Date(),
        updatedAt: new Date()
      }
    ])
  },

  async down (queryInterface, Sequelize) {
    await queryInterface.bulkDelete('Courses', null, {})
  }
};
```

执行种子文件

```sh
sequelize db:seed --seed 20250314063700-course
```

### 模型验证

`models/course.js`

```js
'use strict';
const {
  Model
} = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class Course extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {
      // define association here
    }
  }
  Course.init({
    categoryId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        notNull: {
          msg: '分类 ID 必须填写'
        },
        notEmpty: {
          msg: '分类 ID 不能为空'
        },
        async isPresent(value) {
          const category = await sequelize.models.Category.findByPk(value)
          if (!category) {
            throw new Error(`ID 为 ${value} 的分类不存在`)
          }
        }
      },
    },
    userId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        notNull: {
          msg: '用户 ID 必须填写'
        },
        notEmpty: {
          msg: '用户 ID 不能为空'
        },
        async isPresent(value) {
          const user = await sequelize.models.User.findByPk(value)
          if (!user) {
            throw new Error(`ID 为 ${value} 的用户不存在`)
          }
        }
      }
    },
    name: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '课程名称必须填写'
        },
        notEmpty: {
          msg: '课程名称不能为空'
        },
      },
    },
    image: {
      type: DataTypes.STRING,
      validate: {
        isUrl: {
          msg: '图像地址不正确'
        }
      }
    },
    recommended: {
      type: DataTypes.BOOLEAN,
      validate: {
        isIn: { args: [['true', 'false']], msg: '是否推荐的值必须是，推荐：true 或 不推荐：false'  }
      }
    },
    introductory: {
      type: DataTypes.BOOLEAN,
      validate: {
        isIn: { args: [['true', 'false']], msg: '是否为入门课程的值必须是，入门课程：true 或 不是入门课程：false'  }
      }
    },
    content: DataTypes.TEXT,
    likesCount: DataTypes.INTEGER,
    chaptersCount: DataTypes.INTEGER
  }, {
    sequelize,
    modelName: 'Course',
  });
  return Course;
};
```

### 路由

`routes/admin/courses.js`

```js
const express = require('express')
const router = express.Router()
const { Course } = require('../../models')
const { Op } = require('sequelize')
const {
  NotFoundError,
  success,
  failure
} = require('../../utils/response')

/**
 * 查询课程列表
 * GET /admin/courses
 */
router.get('/', async function(req, res, next) {
  try {
    const query = req.query
    const page = Math.abs(Number(query.page)) || 1
    const pageSize = Math.abs(Number(query.pageSize)) || 10
    const offset = (page - 1) * pageSize
    const condition = {
      order: [['id', 'DESC']],
      limit: pageSize,
      offset
    }
    if (query.categoryId) {
      condition.where = {
        categoryId: {
          [Op.eq]: query.categoryId
        }
      }
    }
    if (query.userId) {
      condition.where = {
        userId: {
          [Op.eq]: query.userId
        }
      }
    }
    if (query.name) {
      condition.where = {
        name: {
          [Op.like]: `%${query.name}%`
        }
      }
    }
    if (query.recommended) {
      condition.where = {
        recommended: {
          [Op.eq]: query.recommended === 'true'
        }
      }
    }
    if (query.introductory) {
      condition.where = {
        introductory: {
          [Op.eq]: query.introductory === 'true'
        }
      }
    }

    const { rows: courses, count: total } = await Course.findAndCountAll(condition)
    success(res, '查询课程列表成功', {
      pagination: { page, pageSize, total },
      courses
    })
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 查询课程详情
 * GET /admin/courses/:id
 */
router.get('/:id', async function(req, res, next) {
  try {
    const course = await getCourse(req)
    success(res, '查询课程详情成功', { course})
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 创建课程
 * POST /admin/courses
 */
router.post('/', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const course = await Course.create(body)
    success(res, '创建课程成功', { course }, 201)
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 删除课程
 * DELETE /admin/courses/:id
 */
router.delete('/:id', async function(req, res, next) {
  try {
    const course = await getCourse(req)
    await course.destroy()
    success(res, '删除课程成功', null)
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 更新课程
 * PUT /admin/courses/:id
 */
router.put('/:id', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const course = await getCourse(req)
    await course.update(body)
    success(res, '更新课程成功', { course })
  } catch (error) {
    failure(res, error)
  }
})

/** 
 * 公共方法 查询当前课程
 * @param {Object} req - 请求
 * @returns {Object} - 当前课程
 */
async function getCourse(req) {
  const { id } = req.params
  const course = await Course.findByPk(id)

  if (!course) {
    throw new NotFoundError(`ID 为 ${id} 的课程未找到`)
  }

  return course
}

/**
 * 公共方法 白名单过滤
 * @param {Object} req - 请求
 * @returns {Object} - 过滤后的参数
 */
function filterBody(req) {
  return {
    categoryId: req.body.categoryId,
    userId: req.body.userId,
    name: req.body.name,
    image: req.body.image,
    recommended: req.body.recommended,
    introductory: req.body.introductory,
    content: req.body.content
  }
}

module.exports = router
```

`app.js`

```js
const adminCoursesRouter = require('./routes/admin/courses')

app.use('/admin/courses', adminCoursesRouter)
```

### 关联模型

在返回的数据中显示的是 userId 和 categoryId，要是能显示他们的数据就好了

在 SQL 语句中需要用连接查询 join

但在 ORM 中就直接用关联模型就可以了

在 Course 模型的 `associate` 中添加属于（belongsTo）

`models/course.js`

```js
'use strict';
const {
  Model
} = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class Course extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {
      // define association here
      models.Course.belongsTo(models.Category, { as: 'category' })
      models.Course.belongsTo(models.User, { as: 'user' })
    }
  }
  Course.init({
    categoryId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        notNull: {
          msg: '分类 ID 必须填写'
        },
        notEmpty: {
          msg: '分类 ID 不能为空'
        },
        async isPresent(value) {
          const category = await sequelize.models.Category.findByPk(value)
          if (!category) {
            throw new Error(`ID 为 ${value} 的分类不存在`)
          }
        }
      },
    },
    userId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        notNull: {
          msg: '用户 ID 必须填写'
        },
        notEmpty: {
          msg: '用户 ID 不能为空'
        },
        async isPresent(value) {
          const user = await sequelize.models.User.findByPk(value)
          if (!user) {
            throw new Error(`ID 为 ${value} 的用户不存在`)
          }
        }
      }
    },
    name: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '课程名称必须填写'
        },
        notEmpty: {
          msg: '课程名称不能为空'
        },
      },
    },
    image: DataTypes.STRING,
    recommended: DataTypes.BOOLEAN,
    introductory: DataTypes.BOOLEAN,
    content: DataTypes.TEXT,
    likesCount: DataTypes.INTEGER,
    chaptersCount: DataTypes.INTEGER
  }, {
    sequelize,
    modelName: 'Course',
  });
  return Course;
};
```

在路由中引入模型，并在条件中使用 include

`routes/admin/courses.js`

```js
const { Course, Category, User } = require('../../models')

/**
 * 查询课程列表
 * GET /admin/courses
 */
router.get('/', async function(req, res, next) {
  try {
    const query = req.query
    const page = Math.abs(Number(query.page)) || 1
    const pageSize = Math.abs(Number(query.pageSize)) || 10
    const offset = (page - 1) * pageSize
    const condition = {
      include: [{
        model: Category,
      }, {
        model: User,
      }],
      order: [['id', 'DESC']],
      limit: pageSize,
      offset
    }
    //...
	}
})
```

但是现在返回数据显示有大写，还有不需要显示的数据，所以继续修改

使用 as 进行别名设置，使用 attributes 过滤字段

`models/course.js`

```js
'use strict';
const {
  Model
} = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class Course extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {
      // define association here
      models.Course.belongsTo(models.Category, { as: 'category' })
      models.Course.belongsTo(models.User, { as: 'user' })
    }
  }
  Course.init({
    categoryId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        notNull: {
          msg: '分类 ID 必须填写'
        },
        notEmpty: {
          msg: '分类 ID 不能为空'
        },
        async isPresent(value) {
          const category = await sequelize.models.Category.findByPk(value)
          if (!category) {
            throw new Error(`ID 为 ${value} 的分类不存在`)
          }
        }
      },
    },
    userId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        notNull: {
          msg: '用户 ID 必须填写'
        },
        notEmpty: {
          msg: '用户 ID 不能为空'
        },
        async isPresent(value) {
          const user = await sequelize.models.User.findByPk(value)
          if (!user) {
            throw new Error(`ID 为 ${value} 的用户不存在`)
          }
        }
      }
    },
    name: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '课程名称必须填写'
        },
        notEmpty: {
          msg: '课程名称不能为空'
        },
      },
    },
    image: DataTypes.STRING,
    recommended: DataTypes.BOOLEAN,
    introductory: DataTypes.BOOLEAN,
    content: DataTypes.TEXT,
    likesCount: DataTypes.INTEGER,
    chaptersCount: DataTypes.INTEGER
  }, {
    sequelize,
    modelName: 'Course',
  });
  return Course;
};
```

`routes/admin/courses.js` 路由中也需要使用 as

```js
const express = require('express')
const router = express.Router()
const { Course, Category, User } = require('../../models')
const { Op } = require('sequelize')
const {
  NotFoundError,
  success,
  failure
} = require('../../utils/response')

/**
 * 查询课程列表
 * GET /admin/courses
 */
router.get('/', async function(req, res, next) {
  try {
    const query = req.query
    const page = Math.abs(Number(query.page)) || 1
    const pageSize = Math.abs(Number(query.pageSize)) || 10
    const offset = (page - 1) * pageSize
    const condition = {
      ...getCondition(),
      order: [['id', 'DESC']],
      limit: pageSize,
      offset
    }
    if (query.categoryId) {
      condition.where = {
        categoryId: {
          [Op.eq]: query.categoryId
        }
      }
    }
    if (query.userId) {
      condition.where = {
        userId: {
          [Op.eq]: query.userId
        }
      }
    }
    if (query.name) {
      condition.where = {
        name: {
          [Op.like]: `%${query.name}%`
        }
      }
    }
    if (query.recommended) {
      condition.where = {
        recommended: {
          [Op.eq]: query.recommended === 'true'
        }
      }
    }
    if (query.introductory) {
      condition.where = {
        introductory: {
          [Op.eq]: query.introductory === 'true'
        }
      }
    }

    const { rows: courses, count: total } = await Course.findAndCountAll(condition)
    success(res, '查询课程列表成功', {
      pagination: { page, pageSize, total },
      courses
    })
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 查询课程详情
 * GET /admin/courses/:id
 */
router.get('/:id', async function(req, res, next) {
  try {
    const course = await getCourse(req)
    success(res, '查询课程详情成功', { course })
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 创建课程
 * POST /admin/courses
 */
router.post('/', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const course = await Course.create(body)
    success(res, '创建课程成功', { course }, 201)
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 删除课程
 * DELETE /admin/courses/:id
 */
router.delete('/:id', async function(req, res, next) {
  try {
    const course = await getCourse(req)
    await course.destroy()
    success(res, '删除课程成功', null)
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 更新课程
 * PUT /admin/courses/:id
 */
router.put('/:id', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const course = await getCourse(req)
    await course.update(body)
    success(res, '更新课程成功', { course })
  } catch (error) {
    failure(res, error)
  }
})

/** 
 * 公共方法 查询当前课程
 * @param {Object} req - 请求
 * @returns {Object} - 当前课程
 */
async function getCourse(req) {
  const { id } = req.params
  const course = await Course.findByPk(id, getCondition())

  if (!course) {
    throw new NotFoundError(`ID 为 ${id} 的课程未找到`)
  }

  return course
}

/**
 * 公共方法 关联分类、用户数据
 */
function getCondition() {
  return {
    attributes: { exclude: ['CategoryId', 'UserId'] },
    include: [{
      model: Category,
      as: 'category',
      attributes: ['id', 'name'],
    }, {
      model: User,
      as: 'user',
      attributes: ['id', 'username', 'avatar']
    }]
  }
}

/**
 * 公共方法 白名单过滤
 * @param {Object} req - 请求
 * @returns {Object} - 过滤后的参数
 */
function filterBody(req) {
  return {
    categoryId: req.body.categoryId,
    userId: req.body.userId,
    name: req.body.name,
    image: req.body.image,
    recommended: req.body.recommended,
    introductory: req.body.introductory,
    content: req.body.content
  }
}

module.exports = router
```

使用 attributes 展示或排除属性

同时其他关联的模型也应该加上对应的 hasMany

`models/user.js`、`models/category.js`

```js
static associate(models) {
	models.User.hasMany(models.Course, { as: 'courses' })
}
```

别名这里使用的复数形式，因为有很多，而不是单条

举例在 categories.js 中使用 include，这样除了能查到自己的信息，还能查到下面课程

```js
/** 
 * 公共方法 查询当前分类
 * @param {Object} req - 请求
 * @returns {Object} - 当前分类
 */
async function getCategory(req) {
  const { id } = req.params
  const condition = {
    include: [
      {
        model: Course,
        as: 'courses',
        attributes: { exclude: ['CategoryId', 'UserId'] }
      }
    ]
  }
  const category = await Category.findByPk(id, condition)

  if (!category) {
    throw new NotFoundError(`ID 为 ${id} 的分类未找到`)
  }

  return category
}
```

注：

- **有关联字段的表**，一定是属于（belongsTo） 其他表的，例如课程表中有 categoryId 和 userId，那么就应该属于分类表和用户表
- 对应的那些表就是拥有 hasMany 很多课程

### 处理孤儿记录

例如：某个课程关联了 id 为 1 的分类或用户，把这个分类或用户删除，这个课程就会找不到对应的分类或用户了，这种没有对应父表记录的数据就叫它孤儿记录

解决方案：

1. 在数据库中设置外键约束，确保数据的完整性，删除的时候就会提示错误，一般在企业中不让使用，因为数据库会产生额外的性能开销，在高并发、数据量大的情况，可能造成性能瓶颈
2. 代码层面处理，删除分类或用户的时候，删除所有关联课程，但不可行
3. 只有没有关联课程的分类，才能被删除（在删除分类的时候，查询一下有没有关联的课程，有对应的课程就提示用户不能删除）

`routes/admin/categories.js`

```js
/**
 * 删除分类
 * DELETE /admin/Category/:id
 */
router.delete('/:id', async function(req, res, next) {
  try {
    const Category = await getCategory(req)

    const count = await Course.count({
      where: {
        categoryId: req.params.id
      }
    })
    if (count > 0) {
      throw new BadRequestError('该分类下存在课程，无法删除')
    }

    await Category.destroy()
    success(res, '删除分类成功', null)
  } catch (error) {
    failure(res, error)
  }
})
```

## 章节接口

### 种子文件

```sh
sequelize seed:generate --name chapter
```

修改

```js
'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up (queryInterface, Sequelize) {
    await queryInterface.bulkInsert('Chapters', [
      {
        courseId: 1,
        title: 'Chapter 1',
        content: 'Chapter 1 description',
        video: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
        rank: 1,
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        courseId: 2,
        title: 'Chapter 2-1',
        content: 'Chapter 2-1 description',
        video: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
        rank: 1,
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        courseId: 2,
        title: 'Chapter 2-2',
        content: 'Chapter 2-2 description',
        video: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
        rank: 2,
        createdAt: new Date(),
        updatedAt: new Date()
      },
    ])
  },

  async down (queryInterface, Sequelize) {
    await queryInterface.bulkDelete('Chapters', null, {});
  }
};
```

运行命令

```sh
sequelize db:seed --seed 20250317025754-chapter
```

### 模型验证和关联模型

`models/chapter.js`

```js
'use strict';
const {
  Model
} = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class Chapter extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {
      models.Chapter.belongsTo(models.Course, { as: 'course' })
    }
  }
  Chapter.init({
    courseId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        notNull: {
          msg: '课程id必须填写'
        },
        notEmpty: {
          msg: '课程id不能为空'
        },
        async isPresent(value) {
          const course = await sequelize.models.Course.findByPk(value)
          if (!course) {
            throw new Error(`ID 为 ${value} 的课程不存在`)
          }
        }
      }
    },
    title: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        notNull: {
          msg: '课程标题必须填写'
        },
        notEmpty: {
          msg: '课程标题不能为空'
        },
        len: {
          args: [2, 45],
          msg: '课程标题应该在 2 到 45 个字符之间'
        }
      }
    },
    content: DataTypes.TEXT,
    video: {
      type: DataTypes.STRING,
      validate: {
        isUrl: {
          msg: '视频地址不正确'
        }
      }
    },
    rank: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        notNull: {
          msg: '排序必须填写'
        },
        notEmpty: {
          msg: '排序不能为空'
        },
        isInt: {
          msg: '排序必须是一个整数'
        },
        isPositive(value) {
          if (value < 0) {
            throw new Error('排序必须大于等于 0')
          }
        }
      }
    }
  }, {
    sequelize,
    modelName: 'Chapter',
  });
  return Chapter;
};
```

`models/course.js`

```js
static associate(models) {
	models.Course.belongsTo(models.Category, { as: 'category' })
	models.Course.belongsTo(models.User, { as: 'user' })
	models.Course.hasMany(models.Chapter, { as: 'chapters' })
}
```

### 路由

`routes/admin/chapters.js`

```js
const express = require('express')
const router = express.Router()
const { Chapter, Course } = require('../../models')
const { Op } = require('sequelize')
const {
  NotFoundError,
  success,
  failure
} = require('../../utils/response')

/**
 * 查询章节列表
 * GET /admin/chapters
 */
router.get('/', async function(req, res, next) {
  try {
    const query = req.query
    const page = Math.abs(Number(query.page)) || 1
    const pageSize = Math.abs(Number(query.pageSize)) || 10
    const offset = (page - 1) * pageSize

    if (!query.courseId) {
      throw new NotFoundError('课程ID不能为空')
    }

    const condition = {
      ...getCondition(),
      order: [['rank', 'ASC'], ['id', 'ASC']],
      limit: pageSize,
      offset
    }
    condition.where = {
      courseId: {
        [Op.eq]: query.courseId
      }
    }
    if (query.title) {
      condition.where = {
        title: {
          [Op.like]: `%${query.title}%`
        }
      }
    }

    const { rows: chapters, count: total } = await Chapter.findAndCountAll(condition)
    success(res, '查询章节列表成功', {
      pagination: { page, pageSize, total },
      chapters
    })
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 查询章节详情
 * GET /admin/chapters/:id
 */
router.get('/:id', async function(req, res, next) {
  try {
    const chapter = await getChapter(req)
    success(res, '查询章节详情成功', { chapter })
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 创建章节
 * POST /admin/chapters
 */
router.post('/', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const chapter = await Chapter.create(body)
    success(res, '创建章节成功', { chapter }, 201)
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 删除章节
 * DELETE /admin/chapters/:id
 */
router.delete('/:id', async function(req, res, next) {
  try {
    const chapter = await getChapter(req)
    await chapter.destroy()
    success(res, '删除章节成功', null)
  } catch (error) {
    failure(res, error)
  }
})

/**
 * 更新章节
 * PUT /admin/chapters/:id
 */
router.put('/:id', async function(req, res, next) {
  try {
    const body = filterBody(req)
    const chapter = await getChapter(req)
    await chapter.update(body)
    success(res, '更新章节成功', { chapter })
  } catch (error) {
    failure(res, error)
  }
})

function getCondition() {
  return {
    attributes: { exclude: ['CourseId'] },
    include: [{
      model: Course,
      as: 'course',
      attributes: ['id', 'name']
    }]
  }
}

/** 
 * 公共方法 查询当前章节
 * @param {Object} req - 请求
 * @returns {Object} - 当前章节
 */
async function getChapter(req) {
  const { id } = req.params
  const chapter = await Chapter.findByPk(id, getCondition())

  if (!chapter) {
    throw new NotFoundError(`ID 为 ${id} 的章节未找到`)
  }

  return chapter
}

/**
 * 公共方法 白名单过滤
 * @param {Object} req - 请求
 * @returns {Object} - 过滤后的参数
 */
function filterBody(req) {
  return {
    courseId: req.body.courseId,
    title: req.body.title,
    content: req.body.content,
    video: req.body.video,
    rank: req.body.rank
  }
}

module.exports = router
```

`app.js`

```js
const adminChaptersRouter = require('./routes/admin/chapters')

app.use('/admin/chapters', adminChaptersRouter)
```

### 避免孤儿记录

`routes/admin/courses.js`

```js
const {
  NotFoundError,
  BadRequestError,
  success,
  failure
} = require('../../utils/response')

/**
 * 删除课程
 * DELETE /admin/courses/:id
 */
router.delete('/:id', async function(req, res, next) {
  try {
    const course = await getCourse(req)

    const count = await Chapter.count({
      where: {
        courseId: req.params.id
      }
    })
    if (count > 0) {
      throw new BadRequestError('该课程下存在章节，无法删除')
    }

    await course.destroy()
    success(res, '删除课程成功', null)
  } catch (error) {
    failure(res, error)
  }
})
```
