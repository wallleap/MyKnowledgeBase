---
title: æ·±å…¥å®¢æˆ·ç«¯å­˜å‚¨å¤§æ¯”æ‹¼
date: 2022-11-17 10:51
updated: 2022-11-17 11:04
cover: //cdn.wallleap.cn/img/post/1.jpg
author: Luwang
comments: true
aliases:
  - æ–‡ç« åˆ«å
rating: 10
tags:
  - å­˜å‚¨
  - å‰ç«¯
category: web
keywords:
  - å…³é”®è¯1
  - å…³é”®è¯2
  - å…³é”®è¯3
description: æ–‡ç« æè¿°
source: //juejin.cn/post/7166636169596239902
url: null
---

## Cookie

### 1.å®¢æˆ·ç«¯å†™Cookie

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051756.webp)

æ³¨æ„ç‚¹ï¼š

- åˆ é™¤cookie,è®¾ç½®cookieçš„è¿‡æœŸæ—¶é—´ä¸ºè¿‡å»æ—¶é—´å³å¯
- è®¾ç½®å¤šä¸ªcookieï¼Œéœ€è¦å¤šæ¬¡è°ƒç”¨document.cookie
- ä¿®æ”¹å’Œåˆ é™¤cookieå­—æ®µï¼Œè¦ä¿éšœpathå’Œdomianå€¼ä¸å˜ï¼Œä¸ç„¶å°±ä¼šå¤±è´¥

### 2.æœåŠ¡ç«¯å†™Cookie

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051757.webp)

### 3.ä¼šè¯æœŸcookie

- å®šä¹‰ï¼šæµè§ˆå™¨ä¼šè¯æœŸé—´çš„cookieï¼Œæµè§ˆå™¨å…³é—­ä»¥åè‡ªåŠ¨åˆ é™¤
- è®¾ç½®ä¼šè¯æœŸcookieï¼šä¸æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼ˆExpiresï¼‰å’Œæœ‰æ•ˆæœŸï¼ˆMax-Ageï¼‰å³å¯

### 4.æŒä¹…åŒ–cookie

- å®šä¹‰ï¼šæŒä¹…åŒ–cookieçš„ç”Ÿå‘½å‘¨æœŸå–å†³äºè¿‡æœŸæ—¶é—´ï¼ˆExpiresï¼‰å’Œæœ‰æ•ˆæœŸï¼ˆMax-Ageï¼‰
- æŒä¹…åŒ–cookieå­˜å‚¨åœ¨å®¢æˆ·ç«¯ç¡¬ç›˜ä¸­
- Max-Ageï¼šcookieæŒä¹…åŒ–æ—¶é—´ï¼ˆå•ä½ç§’ï¼‰ï¼ŒMax-Age:0ï¼Œå¯ä»¥åˆ é™¤cookie

### 5.httpOnly

- å®šä¹‰ï¼šè®¾ç½®ä¸ºtrueï¼Œå¯ä»¥é˜»æ­¢é€šè¿‡ js è®¿é—®cookieã€‚èƒ½æœ‰æ•ˆçš„é˜²æ­¢ XSS æ”»å‡»
- document.cookieæ— æ³•è®¿é—®

### 6.secure

- å®šä¹‰ï¼šè®¾ç½®ä¸ºtrueï¼Œcookieåªä¼šåœ¨ https ç¯å¢ƒä¸‹ä¼ è¾“åˆ°æœåŠ¡ç«¯ã€‚

### 7.cookie ä½œç”¨åŸŸ

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051758.webp)

#### cookie åŒæºå’ŒåŒç«™åŒºåˆ«

- åŒæºï¼šåè®®+ç«¯å£+åŸŸå
- åŒç«™ï¼šæœ‰æ•ˆé¡¶çº§åŸŸå+äºŒçº§åŸŸåï¼Œä¸è€ƒè™‘ç«¯å£å’Œåè®®
- åŒç«™ä¾‹å­ï¼šï¼ˆa.taobao.com/b.taobao.comï¼‰ï¼Œ(127.0.0.1:8000/127.0.0.1:443)
- è·¨ç«™ä¾‹å­ï¼š(a.github.io/b.github.io) ï¼Œå› ä¸º github.io å±äºä¸€ä¸ªæœ‰æ•ˆçš„é¡¶çº§åŸŸå

#### SameSiteè·¨ç«™æºå¸¦cookie

- SameSiteå¿…é¡»å’ŒSecureåŒæ—¶è®¾ç½®æ‰ç”Ÿæ•ˆ
- å‰ç«¯ç«™ç‚¹å’Œåç«¯æ¥å£éƒ½ä¸ºhttps

![](https://cdn.wallleap.cn/img/pic/illustrtion/202211171057377.png)

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051759.webp)

### 8.cookie keyå’Œvalueç¼–è§£ç 

- ä¸ºä»€ä¹ˆè¦ç¼–è§£ç ï¼Ÿ
	- keyå’Œvalueä¸­å‡ºç°åˆ†å·ï¼Œç­‰å·ç­‰ç‰¹æ®Šç¬¦å·ï¼Œå½±å“æˆ‘ä»¬è§£ææ“ä½œ
	- å†™å…¥æ—¶éœ€è¦ä½¿ç”¨ encodeURIComponent() ç¼–ç ï¼Œ
	- è¯»å–æ—¶ä½¿ç”¨ decodeURIComponent() è§£ç 

```
document.cookie = `${encodeURIComponent("ç”¨æˆ·å")}=${encodeURIComponent("äº‘ç‰§")}`;
//ä¸€èˆ¬åç§°ä½¿ç”¨è‹±æ–‡å­—æ¯ï¼Œä¸è¦ç”¨ä¸­æ–‡ï¼Œå€¼å¯ä»¥ç”¨ä¸­æ–‡ï¼Œä½†æ˜¯è¦ç¼–ç 
```

### 9.æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç¦ç”¨cookie

- `window.navigator.cookieEnabled`

### 10.ç¼–å†™cookieå·¥å…·åº“

```JavaScript
/**
 *
 * ç¼–ç  -æ–¹ä¾¿åç»­æ›¿æ¢ç¼–è§£ç æ–¹æ³•
 * @param {any} s
 * @returns
 */
function encode(s) {
return encodeURIComponent(s);
}
/**
 *
 * è§£ç -æ–¹ä¾¿åç»­æ›¿æ¢ç¼–è§£ç æ–¹æ³•
 * @param {any} s
 * @returns
 */
function decode(s) {
return decodeURIComponent(s);
}

/**
 *
 * è·å–cookie
 * @param {any} key
 * @returns
 */
function getCookieItem(key) {
let result = key ? undefined : {},
cookies = document.cookie ? document.cookie.split("; ") : [],
i = 0,
l = cookies.length;
for (; i < l; i++) {
let parts = cookies[i].split("="),
//å–ç¬¬ä¸€ä¸ªç­‰å·å‰é¢çš„ä½œä¸ºkey
name = decode(parts.shift()),
cookie = parts.join("=");

if (key === name) {
result = decode(cookie);
break;
}

if (!key && cookie !== undefined) {
//key æœªå®šä¹‰ï¼Œè¿”å›å…¨éƒ¨çš„keyå’Œvalueå¯¹è±¡
result[name] = decode(cookie);
}
}
return result;
}

/**
 *
 * è®¾ç½®cookie
 * @param {any} key
 * @param {any} value
 * @param {any} [options={}]
 * @returns
 */
function setCookieItem(key, value, options = {}) {
if (!key) return false;
console.log(options);

let sExpires = "";
if (options.expires) {
switch (options.expires.constructor) {
case Number:
sExpires =
options.expires === Infinity
? "; expires=Fri, 31 Dec 9999 23:59:59 GMT"
: "; max-age=" + options.expires;
break;
case String:
sExpires = "; expires=" + options.expires;
break;
case Date:
sExpires = "; expires=" + options.expires.toUTCString();
break;
}
}

window.document.cookie = [
encode(key),
"=",
encode(value),
sExpires,
options.path ? "; path=" + options.path : "",
options.domain ? "; domain=" + options.domain : "",
options.secure ? "; secure" : "",
].join("");
return true;
}

/**
 *
 * ç§»é™¤å•ä¸ªcookieå­—æ®µ
 * @param {any} key
 * @param {any} options
 * @returns
 */
function removeCookieItem(key, options) {
setCookieItem(key, "", { ...options, expires: -1 });
return !getCookieItem(key);
}
```

### 11.æ–°å¼‚æ­¥æ“ä½œCookieAPl-CookieStore

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051760.webp)

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051761.webp)

cookieStore ä¾‹å­ï¼š

```JavaScript
<body>
  <div>
    <button id="btnAdd">æ·»åŠ </button>
    <button id="btnAddFail">æ·»åŠ å¤±è´¥</button>
    <button id="btnDel">åˆ é™¤</button>
    <button id="btnGet">è·å–</button>
    <button id="btnGetAll">è·å–å…¨éƒ¨</button>
  </div>
  <script>
    let index = 1;
    btnAdd.onclick = function () {
      const day = 24 * 60 * 60 * 1000;
      cookieStore
        .set({
        name: `cookie-${index}`,
        value: `cookie-${index}-value`,
        expires: Date.now() + day,
      })
        .then(
        function () {
          console.log("add cookie success");
        },
        function (reason) {
          console.error("add cookie failed: ", reason);
        }
      );
      index++;
    };
    btnAddFail.onclick = function () {
      const day = 24 * 60 * 60 * 1000;
      cookieStore
        .set({
        name: `cookie-1`,
        value: `cookie-1-value`,
        expires: Date.now() + day,
        domain: "test.com",
      })
        .then(
        function () {
          console.log("add cookie success");
        },
        function (reason) {
          console.error("add cookie failed: ", reason);
        }
      );
    };

    btnDel.onclick = function () {
      cookieStore.delete("cookie-1").then(
        function () {
          console.log("delete cookie success");
        },
        function (reason) {
          console.error("delete cookie failed: ", reason);
        }
      );
    };

    btnGet.onclick = function () {
      cookieStore.get({ name: "cookie-1" }).then(
        function (res) {
          console.log("get cookie success:", res);
        },
        function (reason) {
          console.error("get cookie failed: ", reason);
        }
      );
    };

    btnGetAll.onclick = function () {
      cookieStore.getAll().then(
        function (res) {
          console.log("getAll cookie success:", res);
        },
        function (reason) {
          console.error("getAll cookie failed: ", reason);
        }
      );
    };

    cookieStore.addEventListener("change", function (ev) {
      // ev.changed å˜åŒ–çš„
      // ev.deleted åˆ é™¤çš„
      console.log("cookieStorage change:", ev.changed, ev.deleted);
    });
  </script>
</body>
```

CookieStore - service worker ä¸­ä½¿ç”¨

```JavaScript
<body>
  <div>
    <button id="btnAdd">æ·»åŠ æˆ–æ›´æ”¹</button>
    <button id="btnDel">åˆ é™¤</button>
  </div>
  <script>
    let index = 1;
    btnAdd.onclick = function () {
      const day = 24 * 60 * 60 * 1000;
      cookieStore
        .set({
        name: `cookie-x`,
        value: `cookie-x-${index}`,
        expires: Date.now() + day,
      })
        .then(
        function () {
          console.log("add cookie success");
        },
        function (reason) {
          console.error("add cookie failed: ", reason);
        }
      );
      index++;
    };
    btnDel.onclick = function () {
      cookieStore.delete("cookie-x").then(
        function () {
          console.log("delete cookie success");
        },
        function (reason) {
          console.error("delete cookie failed: ", reason);
        }
      );
    };
  </script>
  <script>
    navigator.serviceWorker
      .register("./sw.js", {})
      .then(function (registration) {
      registration.addEventListener("updatefound", function () {
        var installingWorker = registration.installing;
        console.log(
          "A new service worker is being installed:",
          installingWorker
        );
      });
    })
      .catch(function (error) {
      console.log("Service worker registration failed:", error);
    });
  </script>
</body>
```

`sw.js`

```JavaScript
self.addEventListener("install", async (event) => {
console.log("service worker is installed");
const subscriptions = await self.registration.cookies.getSubscriptions();
await self.registration.cookies.unsubscribe(subscriptions);

await self.registration.cookies.subscribe([
{
name: "cookie-x",
},
]);
});

// ç›‘å¬å˜åŒ–
self.addEventListener("cookiechange", (ev) => {
console.log("service worker cookiechange:", ev.changed, ev.deleted);
});

console.log("service worker !!!!");
```

æ³¨æ„äº‹é¡¹

- å®‰å…¨ä¸Šä¸‹æ–‡ä¸­å¯ç”¨ï¼Œæ¯”å¦‚httpsï¼Œlocalhostç­‰
- è¿”å›çš„éƒ½æ˜¯Promise
- Firefox å’Œ Safari ä¸æ”¯æŒ

## WebStorge

### sessionStorage VS localStorage

- sessionStorage ä¸ºæ¯ä¸€ä¸ªç»™å®šçš„æºç»´æŒä¸€ä¸ªç‹¬ç«‹çš„å­˜å‚¨åŒºåŸŸï¼Œè¯¥å­˜å‚¨åŒºåŸŸåœ¨é¡µé¢ä¼šè¯æœŸé—´å¯ç”¨ï¼ˆå³åªè¦æµè§ˆå™¨å¤„äºæ‰“å¼€çŠ¶æ€ï¼ŒåŒ…æ‹¬é¡µé¢é‡æ–°åŠ è½½å’Œæ¢å¤ï¼‰

- localStorage åŒæ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨æµè§ˆå™¨å…³é—­ï¼Œç„¶åé‡æ–°æ‰“å¼€åæ•°æ®ä»ç„¶å­˜åœ¨

- session Storageå’ŒlocalStorageä¸€èˆ¬ç»Ÿç§°ä¸ºWebStorage

ç›¸åŒç‚¹

- éƒ½éµå¾ªåŒæºç­–ç•¥
- å®¹é‡ä¸€æ ·

æ³¨æ„äº‹é¡¹

- æ˜¯åŒæ­¥APlï¼Œé˜»å¡ï¼Œå¦‚æœå­˜å•ä¸ªé”®æˆ–è€…å€¼å¤ªå¤§ï¼Œå½±å“ä½“éªŒ
- å­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸²ï¼Œè¦ä¿å­˜å¯¹è±¡çš„æ—¶å€™ï¼Œéœ€è¦è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œé€šå¸¸ä½¿ç”¨JSON.stringify

```JavaScript
<body>
  <button type="button" id="btnAdd">æ·»åŠ </button>
  <button type="button" id="btnGet">å–å€¼</button>
  <script>
    const str = Array.from({ length: 5 * 1024 * 1023 }, (_) => "äº‘ç‰§").join("");
    const arr = Array.from({ length: 5.12 * 1024 * 33 }, (v, index) => ({
name: "name" + index,
age: ~~(Math.random() * 100),
}));
    btnAdd.onclick = function () {
      console.time(`å­˜é•¿åº¦${str.length}`);
      // localStorage.setItem("_", str);
      localStorage.setItem("_", JSON.stringify(arr));
      console.timeEnd(`å­˜é•¿åº¦${str.length}`);
    };
    btnGet.onclick = function () {
      console.time(`å–é•¿åº¦${str.length}`);
      localStorage.getItem("_");
      console.timeEnd(`å–é•¿åº¦${str.length}`);
    };
  </script>
</body>
```

æ‰“å°ç»“æœå¦‚ä¸‹:

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051762.webp)

### sessionStroageæ˜¯å…±äº«çš„å—ï¼Ÿ

- æ–°æ ‡ç­¾æ‰“å¼€ä¸€ä¸ªé¡µé¢çª—å£æ—¶ä¼š**å¤åˆ¶**é¡¶çº§æµè§ˆä¼šè¯çš„ä¸Šä¸‹æ–‡ä½œä¸ºæ–°ä¼šè¯çš„ä¸Šä¸‹æ–‡
- æ‰“å¼€å¤šä¸ªç›¸åŒçš„ URLçš„ Tabs é¡µé¢ï¼Œä¼šåˆ›å»ºå„è‡ªçš„ session Storage
- 89ç‰ˆæœ¬åï¼Œé€šè¿‡aæ ‡ç­¾target=" blank"è·³è½¬åˆ°æ–°é¡µé¢æ—¶ï¼ŒsessionStorageå°±ä¼šä¸¢å¤±ï¼Œä½†aæ ‡ç­¾æ·»åŠ å±æ€§ rel="opener" èƒ½å¤Ÿå¤åˆ¶ï¼Œä»…ä»…èƒ½å¤åˆ¶ï¼Œä¹‹åçš„æ›´æ”¹å¹¶ä¸ä¼šåŒæ­¥ï¼

### StorageEvent

- å½“å‰é¡µé¢ä½¿ç”¨çš„ storage è¢«å…¶ä»–é¡µé¢ä¿®æ”¹æ—¶ä¼šè§¦å‘ StorageEvent äº‹ä»¶
- äº‹ä»¶åœ¨åŒä¸€ä¸ªåŸŸä¸‹çš„ä¸åŒé¡µé¢ä¹‹é—´è§¦å‘ï¼Œå³åœ¨Aé¡µé¢æ³¨å†Œäº† storge çš„ç›‘å¬å¤„ç†ï¼Œåªæœ‰åœ¨è·ŸAåŒåŸŸåä¸‹çš„Bé¡µé¢æ“ä½œ storage å¯¹è±¡ï¼ŒAé¡µé¢æ‰ä¼šè¢«è§¦å‘ storage äº‹ä»¶ï¼Bé¡µé¢æœ¬èº«ä¸ä¼šè§¦å‘äº‹ä»¶ã€‚

æ³¨æ„ï¼šsessionStorage èƒ½è§¦å‘ StorageEvent äº‹ä»¶å—ï¼Ÿ

- aæ ‡ç­¾æ‰“å¼€ï¼šä¸è§¦å‘
- irameåµŒå¥—ï¼šè§¦å‘

```JavaScript
window.addEventListener("storage", function (e) {
  // é€šè¿‡e.storageAreaåˆ†è¾¨æ˜¯å¦æ˜¯sessionStorageè§¦å‘çš„storageäº‹ä»¶
  if (e.storageArea === sessionStorage) {
    
  }
});
```

### localStorageæ”¯æŒè¿‡æœŸ

#### ç®€å•çš„å®ç°

- æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œè®°ä½è¿‡æœŸçš„æ—¶é—´
- æ·»åŠ æ•°æ®çš„æ—¶å€™ï¼Œä¸€èµ·ä¿å­˜
- æŸ¥è¯¢æ•°æ®ï¼Œæ¯”å¯¹äº‹ä»¶ï¼Œè¿‡æœŸåˆ é™¤

```JavaScript
<div>
  <button type="button" id="btnSetItem">æ·»åŠ </button>
  <button type="button" id="btnGetItem">æŸ¥è¯¢</button>
</div>

<body>
  <script>
    const myLocalStore = {
      setItem: (key, value, expire) => {
        const lsValue = JSON.parse(localStorage.getItem(key) || "{}");
        localStorage.setItem(
          key,
          JSON.stringify({
            ...lsValue,
            value,
            expire,
          })
        );
      },
      getItem: (key) => {
        //Â åœ¨å–å€¼ä¹‹å‰å…ˆåˆ¤æ–­æ˜¯å¦è¿‡æœŸ
        const lsValue = JSON.parse(localStorage.getItem(key) || "{}");
        if (lsValue.expire && lsValue.expire >= Date.now()) {
          return lsValue.value;
        } else {
          localStorage.removeItem(key);
          return null;
        }
      },
    };
  </script>

  <script>
    btnSetItem.onclick = function () {
      myLocalStore.setItem("key-x", "value-1", Date.now() + 10000);
    };
    btnGetItem.onclick = function () {
      console.log("getItem:", myLocalStore.getItem("key-x"));
    };
  </script>
</body>
```

#### ç¬¬ä¸‰æ–¹åº“

- web-storage-cache

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051763.webp)

### localStorageå­˜å‚¨åŠ å¯†

#### ç®€å•åŠ å¯†

- URL æ–¹å¼ï¼šencodeURIComponent + decodeURIComponent
- base64ï¼šwindow.btoa + window.atob

#### å¤æ‚åŠ å¯†

- Web Crypto API çš„ SubtleCrypto æ¥å£æä¾›äº†è®¸å¤šåº•å±‚åŠ å¯†åŠŸèƒ½ã€‚

```html
<style>
  * {
    font-size: 28px;
  }

  .flex {
    display: flex;
  }

  .side {
    flex: 0 0 50%;
  }

  textarea {
    min-height: 400px;
    min-width: 400px;
  }
</style>
<body>
  <div class="flex">
    <div class="side">
      <div>åŠ å¯†å‰å†…å®¹</div>
      <div>
        <textarea id="textAreaClearText"></textarea>
      </div>
    </div>
    <div>
      <div>åŠ å¯†åå†…å®¹</div>
      <div>
        <textarea id="textAreaCipherText"></textarea>
      </div>
    </div>
  </div>

  <div>
    <button type="button" id="btnEncrypt">åŠ å¯†</button>
    <button type="button" id="btnDecrypt">è§£å¯†</button>
  </div>

  <script>
    let publicKey;
    let privateKey;

    let arrayBuffer;
    (async function init() {
      // ç”Ÿæˆç§é’¥(privateKey)å’Œå…¬é’¥(publicKey)
      // åŠ å¯†ç”¨å…¬é’¥ï¼Œ è§£å¯†ç”¨ç§é’¥
      const keyPair = await crypto.subtle.generateKey(
        {
          name: "RSA-OAEP",
          modulusLength: 2048,
          publicExponent: new Uint8Array([1, 0, 1]),
          hash: "SHA-256",
        },
        true,
        ["encrypt", "decrypt"]
      );
      publicKey = keyPair.publicKey;
      privateKey = keyPair.privateKey;
    })();

    /**
 * è¿”å›ArrayBuffer
 */
    function encrypt(text, publicKey) {
      // å­—ç¬¦ä¸²è½¬ä¸ºTypedArray
      const clearText = new TextEncoder().encode(text);
      return window.crypto.subtle.encrypt(
        {
          name: "RSA-OAEP",
        },
        publicKey,
        // an ArrayBuffer, or a TypedArray
        clearText
      );
    }

    /**
 *  cipherText: ArrayBuffer
 *
 */
    async function decrypt(cipherText, privateKey) {
      // cipherText æ˜¯ArrayBuffer
      let decrypted = await window.crypto.subtle.decrypt(
        {
          name: "RSA-OAEP",
        },
        privateKey,
        cipherText
      );
      const dec = new TextDecoder();
      return dec.decode(decrypted);
    }

    btnEncrypt.onclick = async () => {
      const text = textAreaClearText.value;
      arrayBuffer = await encrypt(text, publicKey);

      // ArrayBufferè½¬ä¸ºå­—ç¬¦ä¸²
      const dec = new TextDecoder();
      textAreaCipherText.value = dec.decode(arrayBuffer);
      console.log("arrayBuffer:", arrayBuffer);
    };

    btnDecrypt.onclick = async () => {
      const text = await decrypt(arrayBuffer, privateKey);
      textAreaClearText.value = text;
    };
  </script>
</body>
```

#### ä½¿ç”¨åŠ å¯†åº“

- crypto-js
- secure-Is
- localstorage-slim

### webStorageçš„å­˜å‚¨ç©ºé—´

- localStorage å­˜å‚¨çš„é”®å€¼é‡‡ç”¨ä»€ä¹ˆå­—ç¬¦ç¼–ç ï¼Ÿ
- ç­”æ¡ˆï¼šUTF-16
- UTF-16ï¼Œæ¯ä¸ªå­—ç¬¦ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚ï¼Œæ˜¯æœ‰å‰ææ¡ä»¶çš„ï¼Œå°±æ˜¯ç ç‚¹å°äºOXFFFFï¼ˆ65535ï¼‰ï¼Œå¤§äºè¿™ä¸ªç ç‚¹çš„æ˜¯å››ä¸ªå­—èŠ‚

### 5Må•ä½æ˜¯ä»€ä¹ˆ

æœ‰å‡ ä¸ªé€‰é¡¹

1. å­—ç¬¦çš„ä¸ªæ•°
2. å­—èŠ‚æ•°
3. å­—ç¬¦çš„é•¿åº¦å€¼
4. bitæ•°
5. utf-16ç¼–ç å•å…ƒ

ç­”æ¡ˆæ˜¯3å’Œ5

å­—ç¬¦çš„ä¸ªæ•°å¹¶ä¸ç­‰äºå­—ç¬¦çš„é•¿åº¦

2ä¸ªå­—èŠ‚ä½œä¸ºä¸€ä¸ª utf-16 çš„å­—ç¬¦ç¼–ç å•å…ƒï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ 5M çš„ utf-16 ç¼–ç å•å…ƒ

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051764.webp)

æ³¨æ„ï¼šlocalStorage é”®å å­˜å‚¨ç©ºé—´

```html
<body>
  <button type="button" id="btnSave">ä¿å­˜</button>
  <script>
    btnSave.onclick = function () {
      const charTxt = "a";
      let count = 2.5 * 1024 * 1024;
      let content = Array.from({ length: count }, (_) => charTxt).join("");
      const key = Array.from({ length: count }, (_) => charTxt).join("");
      localStorage.clear();
      try {
        console.time("setItem");
        // æ­¤æ—¶å¦‚æœå†å¤šè®¾ç½®ä¸€ä½å­—ç¬¦å°±ä¼šæŠ¥é”™
        localStorage.setItem(key, content);
        console.timeEnd("setItem");
      } catch (err) {
        console.log("err code:", err.code);
        console.log("err message:", err.message);
      }
    };
  </script>
</body>
```

## indexedDB

- ä¸€ä¸ª**äº‹åŠ¡å‹**æ•°æ®åº“ç³»ç»Ÿ
	- ä¿æŒæ“ä½œåŒæ­¥çš„æˆåŠŸï¼Œæ¯”å¦‚å¤šçª—å£æ“ä½œæ—¶æ•°æ®ä¿æŒåŒæ­¥
- ä¸€ä¸ªåŸºäº JavaScript çš„é¢å‘å¯¹è±¡æ•°æ®åº“
- æ”¯æŒç´¢å¼•
- å¯ä»¥å­˜å‚¨**ç»“æ„åŒ–å…‹éš†ç®—æ³•**æ”¯æŒçš„ä»»ä½•å¯¹è±¡

ä¸èƒ½è¢«ç»“æ„åŒ–å…‹éš†ç®—æ³•å¤åˆ¶çš„æ•°æ®

- Error ä»¥åŠ Function å¯¹è±¡
- DOM èŠ‚ç‚¹
- å±æ€§æè¿°ç¬¦ï¼Œ setters ä»¥åŠ getters
- åŸå½¢é“¾ä¸Šçš„å±æ€§

### indexedDBç‰¹ç‚¹

- éµå¾ªåŒæºç­–ç•¥
- å­˜å‚¨ç©ºé—´ï¼Œé…é¢å¾ˆå¤§
- æ”¯æŒç›´æ¥å­˜å‚¨äºŒè¿›åˆ¶å†…å®¹

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051765.webp)

### åŸºæœ¬æ“ä½œæµç¨‹

1. æ‰“å¼€æ•°æ®åº“
2. åœ¨æ•°æ®åº“ä¸­åˆ›å»º/å¯¹å¼€ä¸€ä¸ªå¯¹è±¡ä»“åº“
3. å¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶å‘é€ä¸€ä¸ªè¯·æ±‚æ¥æ‰§è¡Œä¸€äº›æ•°æ®åº“æ“ä½œï¼Œåƒå¢åŠ æˆ–æå–æ•°æ®ç­‰
4. é€šè¿‡ç›‘å¬ äº‹ä»¶ä»¥ç­‰å¾…æ“ä½œå®Œæˆ
5. ç»§ç»­åç»­çš„æ“ä½œ

```html
<body>
  <div>
    <button id="btnAdd">æ·»åŠ æ•°æ®</button>
    <button id="btnQuery">æŸ¥è¯¢æ•°æ®</button>
  </div>
  <script>
    // https://github.com/mdn/indexeddb-examples/blob/master/idbkeyrange/scripts/main.js
    var db;
    var things = [
      { fThing: "Drum kit", fRating: 10 },
      { fThing: "Family", fRating: 10 },
      { fThing: "Batman", fRating: 9 },
      { fThing: "Brass eye", fRating: 9 },
      { fThing: "The web", fRating: 9 },
      { fThing: "Mozilla", fRating: 9 },
      { fThing: "Firefox OS", fRating: 9 },
      { fThing: "Curry", fRating: 9 },
      { fThing: "Paneer cheese", fRating: 8 },
      { fThing: "Mexican food", fRating: 8 },
      { fThing: "Chocolate", fRating: 7 },
      { fThing: "Heavy metal", fRating: 10 },
      { fThing: "Monty Python", fRating: 8 },
      { fThing: "Aphex Twin", fRating: 8 },
      { fThing: "Gaming", fRating: 7 },
      { fThing: "Frank Zappa", fRating: 9 },
      { fThing: "Open minds", fRating: 10 },
      { fThing: "Hugs", fRating: 9 },
      { fThing: "Ale", fRating: 9 },
      { fThing: "Christmas", fRating: 8 },
    ];

    // æ’å…¥æ•°æ®
    function insertData() {
      // äº‹åŠ¡
      var transaction = db.transaction(["fThings"], "readwrite");
      // å¯¹è±¡åº“
      var objectStore = transaction.objectStore("fThings");
      // æ·»åŠ æ•°æ®
      for (i = 0; i < things.length; i++) {
        var request = objectStore.put(things[i]);
      }
      // æˆåŠŸçš„å›è°ƒ
      transaction.oncomplete = function () {
        console.log("insert data success");
      };
    }

    // æˆ‘ä»¬å…ˆæ‰“å¼€ä¸€ä¸ªæ•°æ®åº“, window.indexedDB(IDBFactory)
    const openRequest = window.indexedDB.open("fThings", 1);
    // å‡çº§çš„æ—¶å€™åˆ›å»ºå¯¹è±¡åº“å’Œå¯¹åº”çš„ç´¢å¼•
    openRequest.onupgradeneeded = function (event) {
      var db = event.target.result;
      db.onerror = function (event) {
        console.log("Error loading database");
      };
      var objectStore = db.createObjectStore("fThings", {
        keyPath: "fThing",
      });
      objectStore.createIndex("fRating", "fRating", { unique: false });
    };

    openRequest.onerror = function (event) {
      console.log("open error:", event);
    };

    openRequest.onsuccess = function (event) {
      console.log("open success");
      // è·å¾—database
      db = event.target.result;
    };

    btnQuery.onclick = function () {
      // äº‹åŠ¡
      const transaction = db.transaction(["fThings"], "readonly");
      // å¯¹è±¡åº“
      const objectStore = transaction.objectStore("fThings");
      // é”®
      const keyRangeValue = IDBKeyRange.bound("A", "F");
      // æ¸¸æ ‡
      objectStore.openCursor(keyRangeValue).onsuccess = function (event) {
        var cursor = event.target.result;
        if (cursor) {
          console.log("value:", cursor.value);
          cursor.continue();
        } else {
          console.log("Entries all displayed.");
        }
      };
    };

    btnAdd.onclick = insertData;
  </script>
</body>
```

### ä½¿ç”¨åœºæ™¯

- ç¼“å­˜æ•°æ®ï¼Œæ¯”å¦‚æ¸¸æˆæ•°æ®
- ç¼“å­˜å›¾ç‰‡ï¼Œè„šæœ¬ï¼Œjsonæ–‡ä»¶ç­‰ç­‰é™æ€èµ„æº
- service workerçš„ç¬¬ä¸‰æ–¹åº“ï¼Œå°±æœ‰åˆ©ç”¨åˆ°indexedDB

### ç¬¬ä¸‰æ–¹åº“

#### localForageï¼ˆå¸¸ç”¨ï¼‰

- localForage æ˜¯ä¸€ä¸ª Java Script åº“ï¼Œé€šè¿‡ç®€å•ç±»ä¼¼ localStorageAPI çš„å¼‚æ­¥å­˜å‚¨æ¥æ”¹è¿›ä½ çš„ Web åº”ç”¨ç¨‹åºçš„ç¦»çº¿ä½“éªŒã€‚å®ƒèƒ½å­˜å‚¨å¤šç§ç±»å‹çš„æ•°æ®ï¼Œè€Œä¸ä»…ä»…æ˜¯å­—ç¬¦ä¸²
- localForage æœ‰ä¸€ä¸ªä¼˜é›…é™çº§ç­–ç•¥ï¼Œè‹¥æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB æˆ– WebSQLï¼Œåˆ™ä½¿ç”¨ localStorage
- localForage æä¾›å›è°ƒ API åŒæ—¶ä¹Ÿæ”¯æŒ ES6 Promises API è‡ªè¡Œé€‰æ‹©

```html
<script src="./localforage.min.js"></script>
<script>
  localforage.config({
    // æŒ‡å®šå­˜å‚¨åª’ä»‹ï¼Œ localStorage, web sql, localStorage
    driver: localforage.INDEXEDDB,
    // æ•°æ®åº“å
    name: "myApp",
    // ç‰ˆæœ¬
    version: 1.0,
    // é…é¢
    size: 4980736,
    // å¯¹è±¡åº“å
    storeName: "keyvaluepairs",
    description: "some description",
  });

  // å®ä¾‹1
  var store = localforage.createInstance({
    name: "nameHere",
  });

  // å®ä¾‹2
  var store2 = localforage.createInstance({
    name: "otherName",
  });

  (async function () {
    // å®ä¾‹1å­˜å’Œå–
    await store.setItem("key-1", "value-1", console.log);
    const storeValue1 = await store.getItem("key-1");
    console.log("store key-1:", storeValue1);
    // å®ä¾‹2å­˜å’Œå–
    await store2.setItem("key-1", "value-1", console.log);
    const store2Value1 = await store.getItem("key-1");
    console.log("store2 key-1:", storeValue1);

    // çº¯äºŒè¿›åˆ¶
    store.setItem("key-2", new Blob(["sdsd"]));
  })();
</script>
```

#### dexie.js

- è§£å†³äº†åŸç”Ÿ indexdb API çš„ä¸‰ä¸ªä¸»è¦é—®é¢˜
	- ä¸æ˜ç¡®çš„é”™è¯¯å¤„ç†
	- ç³Ÿç³•çš„æŸ¥è¯¢
	- ä»£ç å¤æ‚æ€§

```html
<script type="module">
  import Dexie from "./dexie.min.mjs";
  // å®ä¾‹åŒ–
  const db = new Dexie("FriendDatabase");
  db.version(1).stores({
    friends: "++id,name,age",
  });

  try {
    // æ·»åŠ 
    await db.friends.add({ name: "Josephine", age: 21 });
    // æŸ¥è¯¢
    const youngFriends = await db.friends.where("age").below(25).toArray();
    console.log(`My young friends: ${JSON.stringify(youngFriends)}`);
  } catch (e) {
    console.log(`Error: ${e}`);
  }
</script>
```

#### ZangoDBs

- ä¸€ä¸ªç±» MongoDB çš„ IndexedDB æ¥å£å®ç°ï¼Œæä¾›äº†è¯¸å¦‚è¿‡æ»¤ã€æŠ•å½±ã€æ’åºã€æ›´æ–°å’Œèšåˆç­‰å¤§å¤šæ•° MongoDB å¸¸è§çš„ç‰¹æ€§

```html
<script src="./zangodb.min.js"></script>
<script>
  let db = new zango.Db('mydb', { people: ['age'] });
  let people = db.collection('people');

  let docs = [
    { name: 'Frank', age: 20 },
    { name: 'Thomas', age: 33 },
    { name: 'Todd', age: 33 },
    { name: 'John', age: 28 },
    { name: 'Peter', age: 33 },
    { name: 'George', age: 28 }
  ];

  people.insert(docs).then(() => {
    return people.find({
      name: { $ne: 'John' },
      age: { $gt: 20 }
    }).group({
      _id: { age: '$age' },
      count: { $sum: 1 }
    }).project({
      _id: 0,
      age: '$_id.age'
    }).sort({
      age: -1
    }).forEach(doc => console.log('doc:', doc));
  }).catch(error => console.error(error));
</script>
```

#### JsStore

- ä¸€ä¸ªå…·å¤‡ç±» SQL è¯­æ³•çš„ç®€å•å’Œå…ˆè¿›çš„ IndexedDB å°è£…å®ç°ã€‚

```html
<script src="./jsstore.min.js"></script>
<script src="./jsstore.worker.js"></script>
<script>
  // å®šä¹‰æ•°æ®ç»“æ„
  function getDbSchema() {
    var table = {
      name: "Student",
      columns: {
        id: {
          primaryKey: true,
          autoIncrement: true,
        },
        name: {
          notNull: true,
          dataType: "string",
        },
        gender: {
          dataType: "number",
          default: "male",
        },
        country: {
          notNull: true,
          dataType: "string",
        },
        city: {
          dataType: "string",
          notNull: true,
        },
      },
    };

    var db = {
      name: "My-Db",
      tables: [table],
    };
    return db;
  }
  // å®ä¾‹åŒ–
  var jsstoreCon = new JsStore.Connection();

  async function initDb() {
    // åˆ›å»ºæ•°æ®åº“
    var isDbCreated = await jsstoreCon.initDb(getDbSchema());
    if (isDbCreated) {
      console.log("db created");
    } else {
      console.log("db opened");
    }
    // æ·»åŠ 
    await addStudent();
    // æŸ¥è¯¢
    var students = await jsstoreCon.select({
      from: "Student",
    });

    console.log("students", students);
  }

  async function addStudent() {
    try {
      var noOfDataInserted = await jsstoreCon.insert({
        into: "Student",
        values: [
          {
            name: "å°å",
            gender: 1,
            country: "åŒ—äº¬",
            city: "åŒ—äº¬",
          },
          {
            name: "å°çº¢",
            gender: 0,
            country: "æ–°ç–†",
            city: "ä¹Œé²æœ¨é½",
          },
        ],
      });
    } catch (ex) {
      console.log("addStudent error:", ex.message);
    }
  }

  initDb();
</script>
```

## å®¢æˆ·ç«¯å­˜å‚¨ç©ºé—´å¤§æ¯”æ‹¼

å‡†å¤‡å¥½ä¸€ä¸ªå·¥å…·å‡½æ•°æŸ¥è¯¢å½“å‰å­˜å‚¨å­—èŠ‚

```JavaScript
const sizeofUtfBytes = function (str, charset) {
var total = 0,
charCode,
i,
len;
charset = charset ? charset.toLowerCase() : "";
if (charset === "utf-16" || charset === "utf16") {
for (i = 0, len = str.length; i < len; i++) {
charCode = str.charCodeAt(i);
if (charCode <= 0xffff) {
total += 2;
} else {
total += 4;
}
}
} else {
for (i = 0, len = str.length; i < len; i++) {
charCode = str.charCodeAt(i);
if (charCode <= 0x007f) {
total += 1;
} else if (charCode <= 0x07ff) {
total += 2;
} else if (charCode <= 0xffff) {
total += 3;
} else {
total += 4;
}
}
}
return total;
};
```

### Cookie

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051766.webp)

æœ€æ–°ç‰ˆæµè§ˆå™¨100ä¸ªå·¦å³çš„å­˜å‚¨æ•°é‡ä¹Ÿå®Œå…¨ä¸åœ¨è¯ä¸‹

```html
<body>
  cookieå­˜å‚¨ä¸ªæ•°
  <script>
    // utf-8 a:ä¸€ä¸ªå­—èŠ‚ï¼Œ äººï¼šä¸‰ä¸ªå­—èŠ‚
    const charTxt = "a";
    let count = 4 * 1024 - 6;
    console.log(count);
    let content = new Array(parseInt(count)).fill(charTxt).join("");
    const key = "äºº";

    for (let i = 0; i < 100; i++) {
      try {
        console.log("key==", `${key}_${i}`);
        document.cookie = `${key}_${i}=${content}; path=/`;
      } catch (err) {
        console.log("err", err);
      }
    }
  </script>
</body>
```

### localStorage

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051767.webp)

```html
<button id="lBtn">localStorage å­˜å‚¨</button>
<script>
  lBtn.onclick = function () {
    const charTxt = "äºº";
    let count = (10 * 1024 * 1024) / 2 - 8 / 2;
    let content = new Array(count).fill(charTxt).join("");
    const key = "aağŸ”´";
    const key1 = "bbğŸ”´";
    localStorage.clear();
    try {
      localStorage.setItem(key, content);
      //æµ‹è¯•å­˜å‚¨æ˜¯å¦ä¸æ•°é‡æœ‰å…³ã€‚
      localStorage.setItem(key1, content);
    } catch (err) {
      // err.codeä¸º22
      console.log("err", err.code, err);
    }
    const sizeKey = sizeofUtfBytes(key, "utf16");
    const contentSize = sizeofUtfBytes(content, "utf16");
    console.log("key size:", sizeKey, content.length);
    console.log("content size:", contentSize, content.length);
    console.log(
      "total size:",
      sizeKey + contentSize,
      content.length + key.length
    );
  };
</script>
```

### sessionStorage

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051768.webp)

### indexdDB

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051769.webp)

### Cache API ä¸ Service worker

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051770.webp)

### FileSystemï¼ˆéæ ‡å‡†ï¼‰

![image](https://cdn.wallleap.cn/img/pic/illustrtion/202211171051771.webp)

```html
<body>
  <button id="saveFile">å­˜å‚¨æ–‡ä»¶</button>
  <script>
    //1.è·å–fileSystem å¯¹è±¡
    window.requestFileSystem =
      window.requestFilsSystem || window.webkitRequestFileSystem;

    saveFile.onclick = function () {
      // 2.ç”³è¯·ç©ºé—´å¤§å°
      window.requestFileSystem(
        Window.TEMPORARY,
        10 * 1024 * 1024,
        (fs) => {
          //3.åˆ›å»ºæ–‡ä»¶
          fs.root.getFile(
            "test1.txt",
            { create: true, exclusive: false },
            (fileEntry) => {
              //æ‰“å°åˆ›å»ºå¥½çš„æ–‡ä»¶è®¿é—®URL
              console.log(fileEntry.toURL());
              //4. åˆ›å»ºä¸€ä¸ªå†™å…¥å¯¹è±¡
              fileEntry.createWriter((fileWriter) => {
                //æ³¨å†Œä¹¦å†™æˆåŠŸç›‘å¬
                fileWriter.onwriteend = function (e) {
                  console.log("ä¹¦å†™æˆåŠŸ");
                };
                fileWriter.onerror = function (e) {
                  console.log("ä¹¦å†™å¤±è´¥ " + e.toString());
                };
                var blob = new Blob(
                  ["æµ‹è¯•æµ‹è¯•~"],
                  { type: "text/plain" }
                );
                //5. å†™å…¥å†…å®¹
                fileWriter.write(blob);
              });
            },
            (e) => {
              console.log("eee", e);
            }
          );
        },
        (err) => {
          console.log("file error");
        }
      );
    };
  </script>
</body>
å¤åˆ¶ä»£ç 
```

### æ€»ç»“

| ç‰¹æ€§     | cookie               | localStorage          | sessionStorage        | indexedDB  |
| ------ | -------------------- | --------------------- | --------------------- | ---------- |
| æ•°æ®å£°æ˜å‘¨æœŸ | ä¸€èˆ¬ç”±æœåŠ¡å™¨ç”Ÿæˆï¼Œå¯è®¾ç½®è¿‡æœŸæ—¶é—´     | ä¸€ç›´å­˜åœ¨ï¼Œéœ€æ‰‹åŠ¨æ¸…ç†            | æµè§ˆå™¨å…³é—­æ¸…ç†               | ä¸€ç›´å­˜åœ¨ï¼Œéœ€æ‰‹åŠ¨æ¸…ç† |
| æ•°æ®å‚¨å­˜å¤§å° | å•ä¸ªCookieå¤§å°4Kå­—èŠ‚ï¼Œå¯å­˜å‚¨å¤šä¸ª | 10Må­—èŠ‚( 5M UTF-16ç¼–ç å•å…ƒï¼‰ | 10Må­—èŠ‚( 5M UTF-16ç¼–ç å•å…ƒï¼‰ | å‡ åGç”šè‡³æ›´å¤š    |
| æ•°æ®è·å–æ–¹å¼ | åŒæ­¥                   | åŒæ­¥                    | åŒæ­¥                    | å¼‚æ­¥ï¼Œæ”¯æŒäº‹åŠ¡    |
| ä¸æœåŠ¡å™¨é€šè®¯ | ä¼šæºå¸¦åœ¨è¯·æ±‚headerä¸­        | ä¸å‚ä¸                   | ä¸å‚ä¸                   | ä¸å‚ä¸        |
| ä½œç”¨åŸŸ    | åŒç«™                   | åŒæº                    | åŒæºï¼ˆæœ‰é™å®šçª—å£ï¼‰             | åŒæº         |
| å­˜å‚¨ç±»å‹   | å­—ç¬¦ä¸²                  | å­—ç¬¦ä¸²                   | å­—ç¬¦ä¸²                   | å­—ç¬¦ä¸²ï¼ŒäºŒè¿›åˆ¶    |
